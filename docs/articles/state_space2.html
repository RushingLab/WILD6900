<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced state-space models • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced state-space models">
<meta property="og:description" content="WILD6900">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
    <li>
      <a href="../articles/Lecture10/Lecture10.html">Lecture 10: Estimating abundance: N-mixture models</a>
    </li>
    <li>
      <a href="../articles/Lecture11/Lecture11.html">Lecture 11: Estimating abundance: Occupancy modeling</a>
    </li>
    <li>
      <a href="../articles/Lecture12/Lecture12.html">Lecture 12: Estimating abundance: Closed-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture13/Lecture13.html">Lecture 13: Estimating survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture14/Lecture14.html">Lecture 14: Estimating abundance and survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture15/Lecture15.html">Lecture 15: Multi-state models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
    <li>
      <a href="../articles/n-mixture1.html">Introduction to N-mixture models</a>
    </li>
    <li>
      <a href="../articles/n-mixture2.html">Advanced N-mixture models: Zero-inflation and posterior predictive checks</a>
    </li>
    <li>
      <a href="../articles/multi_spp_occ.html">Estimating species richness using hierarchical occupancy models</a>
    </li>
    <li>
      <a href="../articles/cjs.html">Cormack-Jolly-Seber models</a>
    </li>
    <li>
      <a href="../articles/multi-state.html">Quantifying temporary emigration using multi-state models</a>
    </li>
    <li>
      <a href="../articles/multi-state2.html">Multi-state model for survival/transition probability of a perennial plant</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="state_space2_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced state-space models</h1>
            <h3 class="subtitle">Estimating vital rates from count data</h3>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2021-01-05</h4>
      
      
      <div class="hidden name"><code>state_space2.Rmd</code></div>

    </div>

    
    
<p>In the last <a href="https://rushinglab.github.io/WILD6900/articles/state_space.html">lab</a>, we practiced fitting relatively simple state-space models to time series of count data. In this lab, we will expand on that model by fitting a state-space model to age-specific counts. As you will see, the additional information provided by knowing the age class of individuals in the population allows us to gain deeper insights into the drivers of population dynamics.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Fit state-space models to age-specific count data</p></li>
<li><p>Use hierarchical models to partially pool data from spatially replicated counts</p></li>
</ul>
<hr>
<div id="from-population-growth-to-vital-rates" class="section level2">
<h2 class="hasAnchor">
<a href="#from-population-growth-to-vital-rates" class="anchor"></a>From population growth to vital rates</h2>
<p>Imagine a population of individuals that can be visually placed into one of two age classes: juveniles and adults. For now. we will assume that this population is monitored annually just before adults start to breed. Thus, juveniles are individuals that have reached their first birthday and adults are individuals in their 2<span class="math inline">\(^{nd}\)</span> breeding season and beyond. This scenario is reasonable for many species that have distinctive juvenile characteristics but cannot be visually aged once they reach two years of age.</p>
<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/4/42/Setophaga_ruticilla_Dobak.jpg" alt="Adult male American Restart (Setophaga ruticilla), aka the best warbler. Image courtesy of dobak, via Wikicommons" width="80%"><p class="caption">
Adult male American Restart (Setophaga ruticilla), aka the best warbler. Image courtesy of dobak, via Wikicommons
</p>
</div>
<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/e/ea/American_Redstart_-_first_year_male_%2844170250334%29.jpg" alt="Juvenile male American Restart. See the difference?. Image courtesy of Andy Reago and Chrissy McClarren, via Wikicommons" width="80%"><p class="caption">
Juvenile male American Restart. See the difference?. Image courtesy of Andy Reago and Chrissy McClarren, via Wikicommons
</p>
</div>
<p>Unlike the previous count data that we have seen, which included a single count of the total number of individuals in the population each year, counts that separate juveniles and adults allow us to think more mechanistically about changes in abundance. The key to the age-structured state-space model is that knowing the number of juveniles and adults in the population allows us to directly model changes in abundance as functions of vital rates (survival and reproduction). In particular, if we assume the population is closed to movement, we know that juveniles can only be added to the population via births and juvenile survival, i.e. recruitment<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. At any given time <span class="math inline">\(t\)</span>, we therefore expect there to be <span class="math inline">\(N^{Ad}_{t-1} \times F_{t-1}\)</span> juveniles in the population (where <span class="math inline">\(F_t\)</span> is the per capita recruitment rate in year <span class="math inline">\(t\)</span>). Of course, we also expect some process variance to occur and thus <span class="math inline">\(N^{Juv}_t \neq N^{Ad}_{t-1} \times F_{t-1}\)</span>. However, we can model this process variance by assuming the juvenile abundance arises from a Poisson distribution:</p>
<p><span class="math display">\[\large N^{Juv}_{t} \sim Poisson(N^{Ad}_{t - 1}F_{t-1}) \tag{1}\]</span> Equation 1 should look familiar <span class="math inline">\(-\)</span> this is the same model you used in homework 2 to estimate fecundity of the Peregrine falcon population in France. The only differences are that now:</p>
<ol style="list-style-type: decimal">
<li><p>we are estimating recruitment rather than fecundity (our interpretation of <span class="math inline">\(F\)</span> changes slightly, though the way we estimate it remains the same); and</p></li>
<li><p>we are basing our estimates of <span class="math inline">\(F\)</span> on the <em>true</em> population sizes (<span class="math inline">\(N^{Juv}\)</span> and <span class="math inline">\(N^{Ad}\)</span>) rather than counts.</p></li>
</ol>
<p>However, we can link our counts to the true abundance using the state-space structure you have already learned:</p>
<p><span class="math display">\[\large y^{Juv}_t \sim normal(N^{Juv}_t, \tau_{obs}) \tag{2}\]</span></p>
<p>How many adults are in the population in each year? Again, because we are assuming no movement into or out of the population, adults can be added to the population only by juveniles surviving to age 2. Adults can only leave the population by dying.</p>
<p>We will further assume that once they have reached age 1, juveniles survive at the same rate as adults. Therefore, the expected number of adults in the population at time <span class="math inline">\(t\)</span> is equal to the total number of individuals in the population at time <span class="math inline">\(t-1\)</span> (i.e., <span class="math inline">\(N_{t-1} = N^{Juv}_{t-1} + N^{Ad}_{t-1}\)</span>) times the probability that those individuals survive the year. We will denote survival probability as <span class="math inline">\(\phi_t\)</span>. Again, there will be some process variance in the number of surviving individuals, which can model using a binomial distribution:</p>
<p><span class="math display">\[\large N^{Ad}_t \sim binomial(N_{t-1} , \phi_t) \tag{3}\]</span></p>
<p>We again link the true adult abundance to our counts of adults using the now familiar state-space structure:</p>
<p><span class="math display">\[\large y^{Ad}_t \sim normal(N^{Ad}_t, \tau_{obs}) \tag{4}\]</span></p>
<p>Note here that we are assuming the observation error is the same for adults and juveniles. Whether this is a reasonable assumption will depend on the specifics of the study organisms but this assumption could be relaxed by modeling age-specific observation errors (e.g., <span class="math inline">\(\tau^{Juv}_{obs}\)</span> and <span class="math inline">\(\tau^{Ad}_{obs}\)</span>).</p>
<p>The really cool advance of the age-structured state-space model is that with just the four equations outlined above, we have derived mechanistic models that explain variation in abundance via the underlying vital rates and link our imperfect counts to the true abundances! For additional background the concepts that underlie this model, see the <a href="https://www.jstor.org/stable/pdf/41242495.pdf?casa_token=lQLmXK8JwG8AAAAA:Qo7W0yFUH5Db_yRMDuNEj7ob-xnhhgJsr5fv_F_37t7YprY6X8fLxyB2Oy7VoKM1n26D7AuLwvdgbaFquRaaQgUa5UQZuhC3nSan0U7-DmZ6KA74JLc">original paper</a> describing open population count models by Dail and Madsen as well a <a href="https://www.jstor.org/stable/pdf/41242495.pdf?casa_token=lQLmXK8JwG8AAAAA:Qo7W0yFUH5Db_yRMDuNEj7ob-xnhhgJsr5fv_F_37t7YprY6X8fLxyB2Oy7VoKM1n26D7AuLwvdgbaFquRaaQgUa5UQZuhC3nSan0U7-DmZ6KA74JLc">more recent paper</a> by Zipkin et al. describing an age-structured model similar to the one described above.</p>
</div>
<div id="estimating-recruitment-and-survival-of-bighorn-sheep" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-recruitment-and-survival-of-bighorn-sheep" class="anchor"></a>Estimating recruitment and survival of Bighorn sheep</h2>
<p>To see how this model works, we will use a data set of Bighorn sheep (<em>Ovis canadensis</em>) counts generously provided by Wildland Resources graduate student Kylie Sinclair and her adviser Kezia Manlove. Counts of adults females (ewes) and juveniles (lambs) from 5 herds were performed (almost) annually from 1996 to 2015. There are some gaps in the counts in certain years but as we learned in the last exercise, missing counts are not a huge problem in state-space models as long as they are relatively rare.</p>
<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/f/ff/Big_Horn_Sheep_on_Abert_Rim_%288736465058%29.jpg" alt="Big horn sheep photo courtesy of Bureau of Land Management, via Wikicommons" width="80%"><p class="caption">
Big horn sheep photo courtesy of Bureau of Land Management, via Wikicommons
</p>
</div>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h3>
<p>The ewe and lamb counts can be loaded directly into <code>R</code> using the following code (note that if you get an error message, you may need to install an updated version of the <code>WILD6900</code> package):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"ewe_counts"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"lamb_counts"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Year</th>
<th align="right">Waffles</th>
<th align="right">Thunders</th>
<th align="right">Streams</th>
<th align="right">GoatLake</th>
<th align="right">Graphite</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1996</td>
<td align="right">123</td>
<td align="right">19</td>
<td align="right">52</td>
<td align="right">37</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="right">1997</td>
<td align="right">70</td>
<td align="right">18</td>
<td align="right">88</td>
<td align="right">17</td>
<td align="right">24</td>
</tr>
<tr class="odd">
<td align="right">1998</td>
<td align="right">66</td>
<td align="right">24</td>
<td align="right">51</td>
<td align="right">30</td>
<td align="right">16</td>
</tr>
<tr class="even">
<td align="right">1999</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">63</td>
<td align="right">NA</td>
<td align="right">30</td>
</tr>
<tr class="odd">
<td align="right">2000</td>
<td align="right">51</td>
<td align="right">25</td>
<td align="right">40</td>
<td align="right">22</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="right">2001</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">24</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
</div>
<div id="priors" class="section level3">
<h3 class="hasAnchor">
<a href="#priors" class="anchor"></a>Priors</h3>
<p>We will model the dynamics of these herds using the model described by equations 1-4 above. However, in our example we have an added layer of complexity due to jointly modeling the dynamics of different populations. That means we could, in theory, model recruitment and survival as constant across years and herds (we’ll call this the <span class="math inline">\(F(.), \phi(.)\)</span> model), as varying across both years and herds (<span class="math inline">\(F(t, herd), \phi(t, herd)\)</span>), or anything in between (e.g., <span class="math inline">\(F(t), \phi(t)\)</span>, <span class="math inline">\(F(herd), \phi(herd)\)</span>, <span class="math inline">\(F(.), \phi(herd)\)</span>, etc.). Decisions about how to model variation in population parameters is not easy and will often come down to domain expertise (how much variation do we think exists among herds?), statistical limitations (estimating parameters that vary by both herd and year will require a lot of data, which we may not have). More often, you might fit multiple models and then use some type of model selection to determine which model is best supported by your data. Bayesian model selection is a complex and evolving topic and one that we will not get into here. Instead, we will start by fitting the most simple model (<span class="math inline">\(F(.), \phi(.)\)</span>) and then adding complexity.</p>
<p>To implement the <span class="math inline">\(F(.), \phi(.)\)</span> model in JAGS, we first need to define priors for all of the parameters in the model. These parameters include:</p>
<ul>
<li><p><span class="math inline">\(\large F\)</span></p></li>
<li><p><span class="math inline">\(\large \phi\)</span></p></li>
<li><p><span class="math inline">\(\large \sigma_{obs}\)</span></p></li>
</ul>
<p>What priors do you think are most appropriate for these parameters? Once you have decided, using the following code to start a JAGS models with these priors<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="st">"jags/sheep_ssm.jags"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"
model{
  ## Priors
  
  ## Likelihood
  
  ## Derived parameters
}
"</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>As in the previous state-space models, we also need priors for the initial populations sizes for each herd. Here, though, we need to be careful. Our previous models assumed, somewhat simplistically, that abundance <span class="math inline">\(N\)</span> could be any real number. This was a result of assuming normal process variance. In the age-structured model, however, we are assuming that juvenile abundance arises from a Poisson distribution and the adult abundance arises from a binomial. What do these distributions have in common? They are both <em>discrete</em> probability distributions. This means we need to ensure that our priors for initial abundances generate integer values. We will do this in a two step process. First we define a uniform prior for the <em>expected</em> abundance in year 1 for each herd <span class="math inline">\(i\)</span>:</p>
<p><span class="math display">\[\large \mu^{lamb}_{i} \sim uniform(0, 300)\]</span></p>
<p><span class="math display">\[\large \mu^{ewe}_{i} \sim uniform(0, 300)\]</span></p>
<p>Next, we define Poisson priors for the abundances:</p>
<p><span class="math display">\[\large N^{lamb}_{1,i} \sim Poisson(\mu^{lamb}_{i})\]</span></p>
<p><span class="math display">\[\large N^{ewe}_{1,i} \sim Poisson(\mu^{ewe}_{i})\]</span></p>
<p>Using the equations above, add the initial abundance priors to the JAGS model. Remember that you will need to use a <code>for</code> loop to define initial abundance priors for each herd.</p>
</div>
<div id="likelihood" class="section level3">
<h3 class="hasAnchor">
<a href="#likelihood" class="anchor"></a>Likelihood</h3>
<p>With the priors written, we are now ready to write the likelihoods. Both counts and abundances are indexed by year <span class="math inline">\(t\)</span> and herd <span class="math inline">\(i\)</span> so the likelihood will need a set of nested <code>for</code> loops. Because the likelihood for the state process will need to loop over years <code>2:nYears</code> but the observation model will loop over <code>1:nYears</code> it will be easier to make the outer loop correspond to herd <span class="math inline">\(i\)</span> and then have two inner <span class="math inline">\(t\)</span> loops.</p>
<p>Within the likelihood for the state model, the number of ewes needs to be predicted from the total number of sheep in the previous year. You can do this by either defining a new variable <code>N.tot[t,i]</code> and then including that in the binomial likelihood or by including <code>N.ewe[t,i] + N.lamb[t,i]</code> directly in the likelihood. The later results in more compact code but the former allows you to monitor <code>N.tot</code> as another variable in the model.</p>
<p>The likelihood for the observation model will be exactly like the likelihoods for our previous state-space models, but with separate models for the lamb and ewe counts.</p>
<p>Add the full likelihood statement to the JAGS model you started above.</p>
</div>
<div id="derived-parameters-estimating-large-lambda" class="section level3">
<h3 class="hasAnchor">
<a href="#derived-parameters-estimating-large-lambda" class="anchor"></a>Derived parameters: Estimating <span class="math inline">\(\Large \lambda\)</span>
</h3>
<p>A common objective of monitoring studies is estimating the average population growth rate (<span class="math inline">\(\lambda\)</span>) across the study period to determine whether there is a long-term trend in population size. One of the benefits of Bayesian models that we have learned about but not really implemented is the ability to estimate derived variables (and associated uncertainty). Let’s use our estimates of <span class="math inline">\(N\)</span> to derive an estimate of the long-term population growth rate for each herd.</p>
<p>For a time series of abundances, the average growth rate can be estimated as:</p>
<p><span class="math display">\[\large \lambda = \bigg[\frac{N_T}{N_0}\bigg]^{\frac{1}{T}}\]</span></p>
<p>where <span class="math inline">\(T\)</span> is the number of years and <span class="math inline">\(N_0\)</span> is the initial abundance. We can estimate the posterior distribution of <span class="math inline">\(\lambda\)</span> for each herd by simply converting the above equation into working JAGS code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">N.tot</span><span class="op">[</span><span class="va">nYears</span>,<span class="op">]</span><span class="op">/</span><span class="va">N.tot</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">nYears</span><span class="op">)</span></code></pre></div>
<p>which will return a vector of length 5.</p>
</div>
<div id="running-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-model" class="anchor"></a>Running the model</h3>
<p>Finally we’re ready to prepare the data and initial values and fit the model, steps which are hopefully becoming familiar. On your own, complete the following code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bundle data</span>
<span class="va">jags.data</span> <span class="op">&lt;-</span> 

<span class="co"># Initial values</span>
<span class="va">inits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="op">}</span>

<span class="co"># Parameters monitored</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> 

<span class="co"># MCMC settings</span>
<span class="va">ni</span> <span class="op">&lt;-</span> 
<span class="va">nt</span> <span class="op">&lt;-</span> 
<span class="va">nb</span> <span class="op">&lt;-</span> 
<span class="va">nc</span> <span class="op">&lt;-</span> 

<span class="co"># Call JAGS from R </span>
<span class="va">sheep_mod</span> <span class="op">&lt;-</span> <span class="fu">jagsUI</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jagsUI/man/jags.html">jags</a></span><span class="op">(</span><span class="va">jags.data</span>, <span class="va">inits</span>, 
                          <span class="va">parameters</span>, <span class="st">"jags/sheep_ssm.jags"</span>, 
                          n.chains <span class="op">=</span> <span class="va">nc</span>, n.thin <span class="op">=</span> <span class="va">nt</span>, n.iter <span class="op">=</span> <span class="va">ni</span>, 
                          n.burnin <span class="op">=</span> <span class="va">nb</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Now check the model for convergence.</p>
<p>Can can also visualize the observed and estimated counts:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Create data frame with observed and estimated counts</span>
<span class="va">sheep_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">$</span><span class="va">Year</span>, <span class="fl">10</span><span class="op">)</span>,
                       Age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Ewe"</span>, <span class="st">"Lamb"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                       Herd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">)</span><span class="op">)</span>,
                       Count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">ewe_counts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">lamb_counts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                       N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">mean</span><span class="op">$</span><span class="va">N.ewe</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">mean</span><span class="op">$</span><span class="va">N.lamb</span><span class="op">)</span><span class="op">)</span>, 
                       LCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">q2.5</span><span class="op">$</span><span class="va">N.ewe</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">q2.5</span><span class="op">$</span><span class="va">N.lamb</span><span class="op">)</span><span class="op">)</span>,
                       UCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">q97.5</span><span class="op">$</span><span class="va">N.ewe</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sheep</span><span class="op">$</span><span class="va">q97.5</span><span class="op">$</span><span class="va">N.lamb</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Plot herd-specific counts</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">sheep_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Count</span>, group <span class="op">=</span> <span class="va">Herd</span>, color <span class="op">=</span> <span class="va">Herd</span>, fill <span class="op">=</span> <span class="va">Herd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, ymin <span class="op">=</span> <span class="va">LCI</span>, ymax <span class="op">=</span> <span class="va">UCI</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">Herd</span><span class="op">~</span><span class="va">Age</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme</span><span class="op">(</span>strip.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
        strip.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="images/sheep_ssm.png" width="80%" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="adding-complexity" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-complexity" class="anchor"></a>Adding complexity</h2>
<p>Constant recruitment and survival among herds and across years may not be a reasonable assumption. However, as sophisticated Bayesian modelers, you now have the tools to relax that assumption in an almost endless number of ways.</p>
<p>On your own, modify the model code (and any of the associated setup code) to treat recruitment and survival as random effect that vary across both herd and year. In other words,</p>
<p><span class="math display">\[\large F_{t, i} \sim normal(?, ?)\]</span></p>
<p><span class="math display">\[\large \phi_{t, i} \sim normal(?, ?)\]</span></p>
<p>What are the hyper parameters necessary to fit this model? Change the prior statements in your code and then run the model. Do the estimated abundances change? Does this model make more biological sense?</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Historically, per capita fecundity (i.e., the average number of offspring produced per female) is denoted <span class="math inline">\(m\)</span> and the survival of those offspring is denoted <span class="math inline">\(S_0\)</span>. Recruitment, which is the average number of juveniles in the population per female is thus <span class="math inline">\(m \times S_0 = F\)</span><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>State-space models often need some type of weakly informative priors to estimate parameters (we’re asking <em>a lot</em> out of count data after all) and this one is no different. Trial and error indicated that the prior for <span class="math inline">\(\sigma_{obs}\)</span> needs to be somewhat restrictive in order for the model to converge. In test cases of the this model, <span class="math inline">\(uniform(0,25)\)</span> performed relatively well by ensuring that the model can’t sample unrealistically large values for this parameter while also not appearing to artificially truncate the posterior distribution.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
