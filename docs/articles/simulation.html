<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulating linear regression data • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simulating linear regression data">
<meta property="og:description" content="WILD6900">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
    <li>
      <a href="../articles/Lecture10/Lecture10.html">Lecture 10: Estimating abundance: N-mixture models</a>
    </li>
    <li>
      <a href="../articles/Lecture11/Lecture11.html">Lecture 11: Estimating abundance: Occupancy modeling</a>
    </li>
    <li>
      <a href="../articles/Lecture12/Lecture12.html">Lecture 12: Estimating abundance: Closed-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture13/Lecture13.html">Lecture 13: Estimating survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture14/Lecture14.html">Lecture 14: Estimating abundance and survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture15/Lecture15.html">Lecture 15: Multi-state models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
    <li>
      <a href="../articles/n-mixture1.html">Introduction to N-mixture models</a>
    </li>
    <li>
      <a href="../articles/n-mixture2.html">Advanced N-mixture models: Zero-inflation and posterior predictive checks</a>
    </li>
    <li>
      <a href="../articles/multi_spp_occ.html">Estimating species richness using hierarchical occupancy models</a>
    </li>
    <li>
      <a href="../articles/cjs.html">Cormack-Jolly-Seber models</a>
    </li>
    <li>
      <a href="../articles/multi-state.html">Quantifying temporary emigration using multi-state models</a>
    </li>
    <li>
      <a href="../articles/multi-state2.html">Multi-state model for survival/transition probability of a perennial plant</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simulation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simulating linear regression data</h1>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2021-01-05</h4>
      
      
      <div class="hidden name"><code>simulation.Rmd</code></div>

    </div>

    
    
<p>In this activity, we simulate data that will later be used to verify a simple Metropolis sampler to estimate the parameters of a linear regression model.</p>
<p>Simulating data involves many of the same tasks involved in preparing raw data for analysis. Many of the core principles of so called “data wrangling” are embodied by the <a href="https://www.tidyverse.org/packages/"><code>tidyverse</code></a>, a family of packages created to make tidying, manipulating, and visualizing data and model output more intuitive and consistent. Throughout this semester, we will focus on using several of the <code>tidyverse</code> packages to create reproducible data wrangling scripts.</p>
<p>Use of the tidyverse is somewhat <a href="http://varianceexplained.org/r/teach-tidyverse/">controversial</a> and it is worth noting that everything we will do in this lab can be done using base <code>R</code> or non-tidyverse packages. Nonetheless, I find the tidyverse useful <em>because</em> it is opinionated. The developers of the tidyverse have spent a great deal of time thinking about how data should be stored, manipulated, and visualized and they have created an entire ecosystem of functions built around these principles. Using the tidyverse isn’t so much about the tools themselves as it is about <strong>thinking about the structure and manipulation of data</strong>. For better or worse, focusing on consistent application of these principles is not something base <code>R</code> encourages.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Simulate data with known values to verify sampler results using reproducible code</p></li>
<li>
<p>Learn/review basic data manipulation tasks, including:</p>
<ul>
<li>Adding new variables</li>
<li>Saving data</li>
</ul>
</li>
<li>
<p><code>R</code> functions used in this exercise:</p>
<ul>
<li><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/readRDS.html">saveRDS()</a></code></li>
</ul>
</li>
</ul>
<hr>
<div id="what-is-data-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#what-is-data-simulation" class="anchor"></a>What is data simulation</h2>
<p>Data simulation is a technique for generating random data from stochastic processes with known parameters. Although not framed as “data simulation”, we have already done this several times this semester. For example,</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">3</span>, <span class="fl">0.75</span><span class="op">)</span></code></pre></div>
<p>is a simple data simulation to generate random samples from a normal distribution with known mean (<span class="math inline">\(\mu=3\)</span>) and variance (<span class="math inline">\(\sigma^2=0.75^2 = 0.5625\)</span>).</p>
<p>In this exercise, we’ll learn about simulating data under more slightly complex models that are similar to the ones you might use to analyze your data. For example, imagine a simple single-season occupancy model with the probability of occupancy <span class="math inline">\(\psi=0.75\)</span> and detection probability <span class="math inline">\(p=0.4\)</span>. In other words<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>:</p>
<p><span class="math display">\[z_i \sim Bernoulli(\psi)\]</span></p>
<p><span class="math display">\[y_i \sim Bernoulli(z_i \times p)\]</span></p>
<p>We can simulate a data set from this model using a few lines of <code>R</code> code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nSites</span> <span class="op">&lt;-</span> <span class="fl">100</span>  <span class="co"># Number of sites</span>
<span class="va">nVisits</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">psi</span> <span class="op">&lt;-</span> <span class="fl">0.75</span>    <span class="co"># Occupancy probability</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.4</span>       <span class="co"># Detection probability</span>

<span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nSites</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">psi</span><span class="op">)</span>     <span class="co">## Generate true state of each site;</span>
                                                  <span class="co">## nb Bernoulli = binomial with size = 1</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nSites</span><span class="op">*</span><span class="va">nVisits</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">z</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>   <span class="co">## Generate observations</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, nrow <span class="op">=</span> <span class="va">nSites</span>, ncol <span class="op">=</span> <span class="va">nVisits</span><span class="op">)</span></code></pre></div>
<p>With those seven lines of code, we now how a fake data set that could be fed into an occupancy model to estimate <span class="math inline">\(\psi\)</span> and <span class="math inline">\(p\)</span>.</p>
</div>
<div id="why-simulate-data" class="section level2">
<h2 class="hasAnchor">
<a href="#why-simulate-data" class="anchor"></a>Why simulate data?</h2>
<p>At first, it may seem strange to generate a fake data set just so we can run it through a modeling exercise to get answers we already know. But data simulation is a powerful technique in your toolbox as an ecological modeler. There are a number of reasons data simulation is useful<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>:</p>
<ol style="list-style-type: decimal">
<li><p><em>Truth is known</em>: Usually when we apply a model to data, we don’t know the true parameter values that generated the data. In this case, you may be able to fit the model but you’ll never know if it got the right answer. With simulated data, you can check whether your model returns the known parameter values. This is a useful way to make sure you code is doing what you <em>think</em> it’s doing.</p></li>
<li><p><em>Sampling error</em>: As we already learned, sampling error is an inherent part of any ecological analysis. The noise that results from sampling error makes it harder to detect the true signals in our process model. With real data, you only have a single data set, which makes it hard to understand the effect of sampling error on your inference. With simulated data, you can generate hundreds or even thousands of data sets from the same process/observation models, allowing you to observe the effects of sampling error directly.</p></li>
<li><p><em>Check characteristics of estimators</em>: Related to point 1, with a complex model and just a single data set it’s difficult to determine whether the estimators you are using are well-behaved; that is, do they return estimates that are unbiased and precise. With simulated data, you can directly quantify these properties.</p></li>
<li><p><em>Power analysis</em>: By varying the effect sizes and sample sizes in your simulated data, you can easily perform power analyses. Using simulated data in this way can be very useful for designing field studies or helping to interpret inferences after data has been collected and analyzed.</p></li>
<li><p><em>Check identifiability/estimability of parameters</em>: In Bayesian models, we can always obtain posterior distributions for every parameter in our model. However, these posteriors are not always useful. In some cases, our data may provide little-to-no information about the value of a parameter and therefore the posterior distribution for this parameter will simply be determined by the prior. This lack of <em>identifiability</em> may be caused by intrinsic properties of our model (for example, if two parameters are completely confounded such that different combinations of parameter values have the same likelihood) or because our data do not provide enough information to estimate all parameters in the model (for example, a regression model with dozens of predictors but few observations). Although there are rigorous methods for testing intrinsic identifiability, this task can be extremely difficult for complex hierarchical models. Simulated data allow you to check whether all parameters in your model can be estimated by generating replicate data sets that have the same properties (sample size, etc) as your data.</p></li>
<li><p><em>Check robustness to violations of model assumptions</em>: All models have assumptions about how the data were generated. These assumptions stem from the way we formulate the process and observation models. Of course, most assumptions will be violated to some degree in real data sets. With simulated data sets, we can generate data that we know violate the assumptions of the model in one or more ways (e.g., generating heterogeneous survival probabilities for a model that assumes constant survival). By comparing the parameters estimates from these “mis-specified” data sets, we can gauge the degree to which our inferences are sensitive to violations.</p></li>
<li><p><em>Better understand your model</em>: One good way to test whether you really understand your model is to see if you can write the code to simulate data under the model. In many cases, this exercise will uncover misunderstandings or lack of understanding about what the model is actually doing. Simulating data is a good way to make sure you understand what each parameter in your model actually represents. If you can simulate data from each part of the model, chances are you can also figure out why your model may not be working the way you think it does. In short, simulating data is a great way to develop a deeper understanding of your model.</p></li>
</ol>
</div>
<div id="simulating-linear-regression-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-linear-regression-data" class="anchor"></a>Simulating linear regression data</h1>
<p>In this exercise, we will simulate and visualize data generated under a very general process model: a linear regression. Because I’m probably too guilty of being animal focused, we will assume the response variable of the model are counts of the number of seeds produced by the flowers of a rare, endangered orchid. As ecologists studying this orchid, we want to know whether seed production is related to the number of visits by the orchid’s specialist pollinator. Perhaps if it is, we can increase the growth rate of the orchid population by boosting abundance of the pollinator (assuming the number of visits is a function of pollinator abundance).</p>
<p>So we hypothesize that seed number will increase linearly with pollinator visitation. This hypothesis can then be translated into a process model:</p>
<p><span class="math display">\[y_i = \alpha + \beta * x_i + \epsilon_i\]</span> <span class="math display">\[\epsilon_i \sim Normal(0, \sigma^2)\]</span> where <span class="math inline">\(y_i\)</span> is the number of seeds counted in flower <span class="math inline">\(i\)</span> and <span class="math inline">\(x_i\)</span> is the number of pollinator visits. For simplicity, we will assume that we record both <span class="math inline">\(y_i\)</span> and <span class="math inline">\(x_i\)</span> without error. In this model, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are regression coefficients that govern the relationship between seed counts and visitation and <span class="math inline">\(\epsilon_i\)</span> is a normally distribution error term. You may recognize this as a basic linear regression model with a single covariate <span class="math inline">\(x\)</span>.</p>
<hr>
<p><strong>Choosing a probability distribution to describe seed counts</strong></p>
<p>Earlier in the semester, we discussed the Poisson distribution as the default distribution for data that have to be positive integers (e.g., count data). However, in this case, our choice of a linear regression implies normally distributed data. Is this choice justified?</p>
<p>First of all, remember that a linear model is composed to two parts:</p>
<p><span class="math display">\[response = deterministic\; part+stochastic\; part\]</span></p>
<p>The distributional assumptions of a linear model refer to the <em>residuals</em> (the <span class="math inline">\(\epsilon_i\)</span>’s). That is, we assume that there is stochastic error in the response variable (<span class="math inline">\(y_i\)</span>) and this error is equally likely to produce values that are larger or smaller than the value predicted by the deterministic portion of the model (<span class="math inline">\(\alpha + \beta * x_i\)</span>).</p>
<p>For small counts, the Poisson distribution is asymmetrical, meaning that we are more likely to generate values that are larger than the mean than smaller than the mean. You can see this clearly in the histogram below, which was generated from <span class="math inline">\(Poisson(\lambda = 2)\)</span>:</p>
<p><img src="simulation_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;"></p>
<p>In this case, assuming the error terms are normally distribution would likely be inappropriate. However, as counts get larger, the Poisson distribution starts to appear more “normal”:</p>
<p><img src="simulation_files/figure-html/unnamed-chunk-4-1.png" width="768" style="display: block; margin: auto;"></p>
<p>In this case, <span class="math inline">\(\mu = \lambda = 500\)</span>. So as counts get bigger, there will be very little difference in the results of a linear regression or a Poisson GLM.<br>
***</p>
</div>
<div id="step-0-set-up-your-workspace-and-directories" class="section level1">
<h1 class="hasAnchor">
<a href="#step-0-set-up-your-workspace-and-directories" class="anchor"></a>Step 0: Set up your workspace and directories</h1>
<p>Hopefully you have already created a main directory for this course when you started the homework assignment on choosing priors. If you have not already done so, create a sub-directory of that folder called <code>data</code>.</p>
<p>For this exercise, create a new script and add it to whatever sub-directory you will use to store analysis scripts (alternatively, you could add this script to the <code>data</code> or <code>data-raw</code> folders since we’ll use it to create data. Just use whatever system makes most sense to you). In the next section, copy the code from the markdown file into this script.</p>
</div>
<div id="step-1-set-the-model-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#step-1-set-the-model-parameters" class="anchor"></a>Step 1: Set the model parameters</h1>
<p>The first step to simulating data is to set the fixed values that are needed to generate the stochastic data. This usually includes the sample size, covariate and parameter values and any other fixed value relevant to the analysis. In this case, we’ll first set the number of flowers that we counted seeds from:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">175</span> <span class="co"># Number of flowers</span></code></pre></div>
<p>Next, we need to generate the covariate values, in this case pollination visits. We’ll store these values in a data frame and assume the number of visits ranges from 0 to 25:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>visits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span> <span class="co"># Number of pollination visits</span></code></pre></div>
<p>A common task during data preparation is adding new variables that are derived from variables in the raw data. In our example, we might want to add a new variable with <em>scaled</em> values of the covariate. In most analyses, it is good practice to scale covariate values so they have a mean of 0 and do not extend too far above and below 0 (very large values (positive or negative) can create numerical issues when fitting models). So next we center and scale the visit covariate (we’ll do it manually but it could also be done using the built-in function <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> or by simply simulating data from a normal distribution in the first place).</p>
<p>In the tidyverse, the workhorse of adding new variables in <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">sim_df</span>, visits.c <span class="op">=</span> <span class="op">(</span><span class="va">visits</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">visits</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">visits</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You can check that the covariate now has mean = 0 and sd = 1.</p>
<hr>
<p><strong>NOTE</strong></p>
<p>It can sometimes be confusing to know which functions come from which packages (or to know which function <code>R</code> will default to using). For this reason, it’s good practice to get in the habit of using the <code>package::function()</code> syntax, as we did for <code>mutate()</code> above. Using this syntax makes explicit which package/function you intend to use which makes your code easier for other to understand and reduces the potential for errors. As a benefit, you can stop using <code><a href="https://rdrr.io/r/base/library.html">library(package)</a></code> at the beginning of each script.</p>
<hr>
<p>Finally, we need to set the parameter values for the regression models. This is where understanding what each parameter represents is very helpful. For example, <span class="math inline">\(\alpha\)</span> is the expected number of seeds when the covariate has a value of 0 (because we centered visits, we interpret <span class="math inline">\(\alpha\)</span> to be the expected number of seeds at the mean number of visits):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">250</span> <span class="co"># Expected number of seeds at mean number of visits</span></code></pre></div>
<p>Now we set <span class="math inline">\(\beta\)</span> coefficient. We have already said the <span class="math inline">\(\beta\)</span> is positive (seed count increases with visits). All that’s left is to decide a specific value. Remember that we interpret <span class="math inline">\(\beta\)</span> as the additional number of seeds for 1 sd increase in the number of visits.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">50</span>   <span class="co"># Effect of visits on seed count</span></code></pre></div>
</div>
<div id="step-2-generate-expected-counts" class="section level1">
<h1 class="hasAnchor">
<a href="#step-2-generate-expected-counts" class="anchor"></a>Step 2: Generate expected counts</h1>
<p>To generate the simulated seed counts for each flower, we first have to calculate <span class="math inline">\(\mu_i\)</span>, the <em>expected</em> seeds for each flower. We get these values by simply plugging in the observed visitation values for each site to our linear model:</p>
<p><span class="math display">\[\begin{bmatrix}
    \mu_1 \\
    \mu_2 \\
    \mu_3 \\
    .\\
    .\\
    .\\
    \mu_N
\end{bmatrix} = \begin{bmatrix}
    1  &amp; visits_1\\
    1  &amp; visits_2\\
    1  &amp; visits_3\\
    . &amp; .\\
    . &amp; .\\
    . &amp; .\\
    1  &amp; visits_N
\end{bmatrix} \times
\begin{bmatrix}
    \alpha\\
    \beta 
\end{bmatrix}\]</span></p>
<p>If you remember matrix algebra, multiplying the covariate matrix by the coefficient matrix is the same as doing:</p>
<p><span class="math display">\[1 \times \alpha + visits_i \times \beta\]</span></p>
<p>The matrix of predicted responses is called the <em>linear predictor</em>.</p>
<p>Now that we have a refreshed our memory of the basic linear model structure, let’s add the predicted seed counts to the data frame:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">sim_df</span>, mu <span class="op">=</span> <span class="va">alpha</span> <span class="op">+</span> <span class="va">beta</span><span class="op">*</span><span class="va">visits.c</span><span class="op">)</span></code></pre></div>
<div id="step-2b-plot-relationships" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2b-plot-relationships" class="anchor"></a>Step 2b: Plot relationships</h2>
<p>Whenever you simulate data, it’s very useful to plot your data early and often. It is often difficult to know ahead of time exactly what response values a complex model will produce. Plots are a great way to quickly assess whether the simulation is producing values that are consistent with your domain expertise.</p>
<div id="brief-intro-to-ggplot2" class="section level3">
<h3 class="hasAnchor">
<a href="#brief-intro-to-ggplot2" class="anchor"></a>Brief intro to <code>ggplot2</code>
</h3>
<p>To be consistent with our use of the <code>tidyverse</code>, we will create plots using <code>ggplot2()</code>.</p>
<p>The power and flexibility of <code>ggplot2</code> come from it’s consistent structure. Although a bit overwhelming at first, once you get the hang of it the structure actually makes it quite easy to create highly customized publication-quality graphics. All plots created using <code>ggplot2</code> use the same underlying structure:</p>
<p><span class="math display">\[\underbrace{ggplot}_{initiate\; plot}(\underbrace{data = df}_{data\;frame},\; \underbrace{aes(x =\; , y = \;)}_{plot\; attributes}) + \underbrace{geom\_line()}_{geometry}\]</span></p>
<p>The <code>ggplot()</code> function initiates a new plot. In this function, you tell <code>ggplot2</code> what data frame you will be using for the plot and you tell it how to map attributes of the data to the visual properties of the figures. Attributes are mapped inside the <code>aes()</code> argument. Attributes usually include location (<code>x-axis</code> and <code>y-axis</code> placement), color, size, shape, line type, and many others. In general, each attribute will be mapped to one column of your data frame.</p>
<p>The <code>ggplot()</code> function simply initiates a graph so if you run just that portion of the code you will get a blank graph. We can see that by creating a new plot showing the relationship between elevation (the x-axis of the plot) and predicted abundance (the y-axis):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">visits</span>, y <span class="op">=</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
<p>You can see that <code>ggplot</code> created a figure with the correct axes and labels. But no data. That’s because we didn’t tell <code>ggplot</code> what type of <em>geometry</em> to use to represent the data. Geometry refers to the actual type geometric object(s) we want to use to display the data. Common geometries include points (e.g., scatterplot), lines (e.g., time series), and bars (e.g., histograms). There are many others. Once we add a geometry, we can see the data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">visits</span>, y <span class="op">=</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
<p>So we can see that our model predicts seed counts ranging from 167.06 individuals to 332.04. Is that reasonable? Who knows, this is a made up species. But if it wasn’t, this would be a good time to go back and play with different parameter values to generate abundances that are consistent with our domain expertise. For example, the model predicts <span class="math inline">\(\approx\)</span> 167.06 seeds for a flower with 0 pollination visits. Maybe that makes sense (perhaps the orchids can self-pollinate if necessary) or maybe it doesn’t. If it doesn’t, we need to re-think the model structure.</p>
</div>
</div>
</div>
<div id="step-3-generate-the-actual-seed-counts" class="section level1">
<h1 class="hasAnchor">
<a href="#step-3-generate-the-actual-seed-counts" class="anchor"></a>Step 3: Generate the actual seed counts</h1>
<p>So far, our simulated seed counts contain no stochastic variation (the visitation covariate is stochastic but given that value, the predicted counts are completely deterministic). To create a realistic data set, we need to add some process variance (<span class="math inline">\(\sigma^2_p\)</span>). In our example, this requires setting another parameter that controls the amount of process variation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">7.5</span></code></pre></div>
<p>Now we simply generate random seed counts using the linear predictor and the process variation</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">### Generate actual abundance for each site</span>
<span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">sim_df</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">N</span>, <span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>

<span class="co">### Plot lambda vs. N</span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mu</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-14-1.png" width="576" style="display: block; margin: auto;"></p>
<p>As expected, seed count increases with <span class="math inline">\(\mu\)</span>, though you can see the process variation that is added to the model at this stage.</p>
</div>
<div id="step-4-save-the-simulated-data" class="section level1">
<h1 class="hasAnchor">
<a href="#step-4-save-the-simulated-data" class="anchor"></a>Step 4: Save the simulated data</h1>
<p>Now that we have a simulated data set, let’s save it so it’s available for future use. There are many ways to save objects in <code>R</code> but one of the most <a href="https://www.fromthebottomoftheheap.net/2012/04/01/saving-and-loading-r-objects/">well-behaved</a> is <code><a href="https://rdrr.io/r/base/readRDS.html">saveRDS()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sim_df</span>, file <span class="op">=</span> <span class="st">"data/sim_seed_counts.rds"</span><span class="op">)</span></code></pre></div>
<p>When you want to use this object in the future, all you have to do is run<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/sim_seed_counts.rds"</span><span class="op">)</span></code></pre></div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Note that <span class="math inline">\(z_i\)</span> can either be 1 (site <span class="math inline">\(i\)</span> is occupied) or 0 (site <span class="math inline">\(i\)</span> is unoccupied) and <span class="math inline">\(y_i\)</span> can be 1 (species detected at site <span class="math inline">\(i\)</span>) or 0 (species not detected at site <span class="math inline">\(i\)</span>). In the second equation, adding <span class="math inline">\(z_i\)</span> ensures that if the site is unoccupied (<span class="math inline">\(z_i=0\)</span>) than <span class="math inline">\(y_i\)</span> has to be 0 also. We’ll learn more about this formulation of occupancy models later in the semester<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Based on chapter 4 of Kery &amp; Royle <em>Applied Hierarchical Modeling in Ecology</em><a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Note that with <code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code> you do have to assign the object you are reading to a new object. If you don’t create a new object, <code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code> will simply print the data frame. This has the advantage that you can rename the object something else when you read it in next time.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
