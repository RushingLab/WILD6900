<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating survival and stage-transitions of a perennial plant using multi-state capture-recapture models • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimating survival and stage-transitions of a perennial plant using multi-state capture-recapture models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2020.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
    <li>
      <a href="../articles/Lecture10/Lecture10.html">Lecture 10: Estimating abundance: N-mixture models</a>
    </li>
    <li>
      <a href="../articles/Lecture11/Lecture11.html">Lecture 11: Estimating abundance: Occupancy modeling</a>
    </li>
    <li>
      <a href="../articles/Lecture12/Lecture12.html">Lecture 12: Estimating abundance: Closed-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture13/Lecture13.html">Lecture 13: Estimating survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture14/Lecture14.html">Lecture 14: Estimating abundance and survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture15/Lecture15.html">Lecture 15: Multi-state models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
    <li>
      <a href="../articles/n-mixture1.html">Introduction to N-mixture models</a>
    </li>
    <li>
      <a href="../articles/n-mixture2.html">Advanced N-mixture models: Zero-inflation and posterior predictive checks</a>
    </li>
    <li>
      <a href="../articles/multi_spp_occ.html">Estimating species richness using hierarchical occupancy models</a>
    </li>
    <li>
      <a href="../articles/cjs.html">Cormack-Jolly-Seber models</a>
    </li>
    <li>
      <a href="../articles/multi-state.html">Quantifying temporary emigration using multi-state models</a>
    </li>
    <li>
      <a href="../articles/multi-state2.html">Multi-state model for survival/transition probability of a perennial plant</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="multi-state2_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Estimating survival and stage-transitions of a perennial plant using multi-state capture-recapture models</h1>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2020-02-06</h4>
      
      
      <div class="hidden name"><code>multi-state2.Rmd</code></div>

    </div>

    
    
<p>In this lab, we’ll continue to explore multi-state models using a data set from Kéry &amp; Schaub (2015). The data comes from a long-term study of Showy Lady’s Slipper (<em>Cypripedium reginae</em>) in West Virginia (Kéry &amp; Gregg 2004). This perennial orchid is one of the tallest orchid species native to North America and is the state flower of Minnesota. The species has always been rare but in recent decades it has been extirpated throughout much of its range due to habitat loss.</p>
<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Showy_Lady%27s_Slipper_-_Minnesota_State_Flower_-_panoramio.jpg" alt="The Showy Lady's Slipper. Image courtesy of shcostello via Wikicommons (CC BY 3.0)" width="75%"><p class="caption">
The Showy Lady’s Slipper. Image courtesy of shcostello via Wikicommons (CC BY 3.0)
</p>
</div>
<p>Why, you may ask, should we perform a mark-recapture study to estimate the survival of a plant species? First, individual plants can remain dormant below ground in years when conditions are not suitable for growth. As a result, even if detection probability is 1 for plants in the vegetative and flowering stages, we do not know the true state (dead or alive) of dormant plants. Second, the multi-state model is a natural framework for estimating transitions between stages (vegetative to flowering, dormant to flowering, etc.). These transition probabilities form the basis for matrix projection models so the ability to estimate them at the same time as survival is a big advantage of this modeling framework.</p>
<p>Following Kéry &amp; Gregg (2004) and Kéry &amp; Schaub (2015), we will define four states: “vegetative”, “flowering”, “dormant”, and “dead”. Individuals that are in the vegetative, flowering, and dormant states can die with probability <span class="math inline">\(s\)</span> (note that because there is not emigration in plants, we can model true rather than apparent survival). Individuals can also transition between stages or remain in their current state with probabilities:</p>
<ul>
<li><p><span class="math inline">\(\psi_{VV}\)</span>: probability of staying in the vegetative state</p></li>
<li><p><span class="math inline">\(\psi_{FV}\)</span>: probability of transitioning from flowering to vegetative</p></li>
<li><p><span class="math inline">\(\psi_{DV}\)</span>: probability of transitioning from dormant to vegetative</p></li>
<li><p><span class="math inline">\(\psi_{FF}\)</span>: probability of staying in the flowering state</p></li>
<li><p><span class="math inline">\(\psi_{VF}\)</span>: probability of transitioning from vegetative to flowering</p></li>
<li><p><span class="math inline">\(\psi_{DF}\)</span>: probability of transitioning from dormant to flowering</p></li>
<li><p><span class="math inline">\(\psi_{DD}\)</span>: probability of staying in the dormant state</p></li>
<li><p><span class="math inline">\(\psi_{VD}\)</span>: probability of transitioning from flowering to dormant</p></li>
<li><p><span class="math inline">\(\psi_{FD}\)</span>: probability of transitioning from flowering to dormant</p></li>
</ul>
<table class="table table table-striped table-hover table-condensed table-responsive">
<thead><tr>
<th style="text-align:center;">
</th>
<th style="text-align:center;">
Vegetative
</th>
<th style="text-align:center;">
Flowering
</th>
<th style="text-align:center;">
Dormant
</th>
<th style="text-align:center;">
Dead
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:center;">
Vegetative
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{VV}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{VF}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{VD}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 - s\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Flowering
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{FV}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{FF}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{FD}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 -s\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Dormant
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{DV}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{DF}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(s \psi_{DD}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 -s\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Dead
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
</tbody>
</table>
<p>We will assume, following Kéry &amp; Gregg (2004), that individuals in the vegetative and flowering states are observed perfectly and that dead or dormant individuals are never detected. Therefore:</p>
<table class="table table table-striped table-hover table-condensed table-responsive">
<thead><tr>
<th style="text-align:center;">
</th>
<th style="text-align:center;">
Seen veg.
</th>
<th style="text-align:center;">
Seen flow.
</th>
<th style="text-align:center;">
Not Seen
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:center;">
Vegetative
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
</tr>
<tr>
<td style="text-align:center;">
Flowering
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
<td style="text-align:center;">
0
</td>
</tr>
<tr>
<td style="text-align:center;">
Dormant
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
<tr>
<td style="text-align:center;">
Dead
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
</tbody>
</table>
<div id="reading-in-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-in-the-data" class="anchor"></a>Reading in the data</h2>
<p>Capture histories for 490 individual plants over an 8 year period are providing by Kéry &amp; Schaub (2015):</p>
<ul>
<li><p>observed vegetative is coded as 1</p></li>
<li><p>observed flowering is coded as 2</p></li>
<li><p>not observed is coded as 0</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"ladyslipper"</span>)</a></code></pre></div>
<p>Next, determine the first capture occasion of each individual and recode “not seen” as <code>3</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># First capture occasion</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(ladyslipper, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(x <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># Recode "not seen" as 3</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">rCH &lt;-<span class="st"> </span>ladyslipper</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">rCH[rCH <span class="op">==</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span><span class="dv">3</span></a></code></pre></div>
</div>
<div id="the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#the-model" class="anchor"></a>The model</h2>
<p>Here’s the JAGS code to fit this model. In this case, we will assume that survival probability <span class="math inline">\(s\)</span> can vary across occasions and treat it as a random effect.</p>
<p>Priors for the transition probabilities require a distribution we haven’t seen yet: the Dirichlet. The Dirichlet prior is used when we need to put priors on a vector of probabilities that must sum to 1. To implement the Dirichlet prior in JAGS, we define a set of hyperpriors, one for each element in the vector of probabilities, call these <span class="math inline">\(a_j\)</span>. We put a vague gamma prior on each hyperprior and then estimate the transition probabilities as <span class="math inline">\(\psi_{ij} = \frac{a_j}{\sum_{j = 1}^n a_j}\)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>(<span class="st">"jags/ladyslipper.jags"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">model {</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="st"># -------------------------------------------------</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="st"># Parameters:</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="st"># s: survival probability</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="st"># psiV: transitions from vegetative</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="st"># psiF: transitions from flowering</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="st"># psiD: transitions from dormant</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="st"># -------------------------------------------------</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="st"># States (S):</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="st"># 1 vegetative</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="st"># 2 flowering</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="st"># 3 dormant</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="st"># 4 dead</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="st"># Observations (O):  </span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="st"># 1 seen vegetative </span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="st"># 2 seen flowering</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="st"># 3 not seen</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="st"># -------------------------------------------------</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="st"># Priors and constraints</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="st">   # Survival: uniform</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="st">   for (t in 1:(n.occasions-1)){  </span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="st">      s[t] ~ dunif(0, 1)</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="st">      }</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="st">   # Transitions: gamma priors</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="st">   for (i in 1:3){</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="st">      a[i] ~ dgamma(1, 1)</span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="st">      psiD[i] &lt;- a[i]/sum(a[])</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="st">      b[i] ~ dgamma(1, 1)</span></a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="st">      psiV[i] &lt;- b[i]/sum(b[])</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="st">      c[i] ~ dgamma(1, 1)</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="st">      psiF[i] &lt;- c[i]/sum(c[])</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="st">      }</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="st"># Define state-transition and observation matrices  </span></a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="st">   # Define probabilities of state S(t+1) given S(t)</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="st">   for (t in 1:(n.occasions-1)){</span></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"><span class="st">      ps[1,t,1] &lt;- s[t] * psiV[1]</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"><span class="st">      ps[1,t,2] &lt;- s[t] * psiV[2]</span></a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="st">      ps[1,t,3] &lt;- s[t] * psiV[3]</span></a>
<a class="sourceLine" id="cb3-44" data-line-number="44"><span class="st">      ps[1,t,4] &lt;- 1-s[t]</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="st">      ps[2,t,1] &lt;- s[t] * psiF[1]</span></a>
<a class="sourceLine" id="cb3-46" data-line-number="46"><span class="st">      ps[2,t,2] &lt;- s[t] * psiF[2]</span></a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="st">      ps[2,t,3] &lt;- s[t] * psiF[3]</span></a>
<a class="sourceLine" id="cb3-48" data-line-number="48"><span class="st">      ps[2,t,4] &lt;- 1-s[t]</span></a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="st">      ps[3,t,1] &lt;- s[t] * psiD[1]</span></a>
<a class="sourceLine" id="cb3-50" data-line-number="50"><span class="st">      ps[3,t,2] &lt;- s[t] * psiD[2]</span></a>
<a class="sourceLine" id="cb3-51" data-line-number="51"><span class="st">      ps[3,t,3] &lt;- s[t] * psiD[3]</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52"><span class="st">      ps[3,t,4] &lt;- 1-s[t]</span></a>
<a class="sourceLine" id="cb3-53" data-line-number="53"><span class="st">      ps[4,t,1] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-54" data-line-number="54"><span class="st">      ps[4,t,2] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-55" data-line-number="55"><span class="st">      ps[4,t,3] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56"><span class="st">      ps[4,t,4] &lt;- 1</span></a>
<a class="sourceLine" id="cb3-57" data-line-number="57"></a>
<a class="sourceLine" id="cb3-58" data-line-number="58"><span class="st">      # Define probabilities of O(t) given S(t)</span></a>
<a class="sourceLine" id="cb3-59" data-line-number="59"><span class="st">      po[1,t,1] &lt;- 1</span></a>
<a class="sourceLine" id="cb3-60" data-line-number="60"><span class="st">      po[1,t,2] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-61" data-line-number="61"><span class="st">      po[1,t,3] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-62" data-line-number="62"><span class="st">      po[2,t,1] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-63" data-line-number="63"><span class="st">      po[2,t,2] &lt;- 1</span></a>
<a class="sourceLine" id="cb3-64" data-line-number="64"><span class="st">      po[2,t,3] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-65" data-line-number="65"><span class="st">      po[3,t,1] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-66" data-line-number="66"><span class="st">      po[3,t,2] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-67" data-line-number="67"><span class="st">      po[3,t,3] &lt;- 1</span></a>
<a class="sourceLine" id="cb3-68" data-line-number="68"><span class="st">      po[4,t,1] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-69" data-line-number="69"><span class="st">      po[4,t,2] &lt;- 0</span></a>
<a class="sourceLine" id="cb3-70" data-line-number="70"><span class="st">      po[4,t,3] &lt;- 1</span></a>
<a class="sourceLine" id="cb3-71" data-line-number="71"><span class="st">   } #t</span></a>
<a class="sourceLine" id="cb3-72" data-line-number="72"></a>
<a class="sourceLine" id="cb3-73" data-line-number="73"><span class="st"># Likelihood </span></a>
<a class="sourceLine" id="cb3-74" data-line-number="74"><span class="st">for (i in 1:nind){</span></a>
<a class="sourceLine" id="cb3-75" data-line-number="75"><span class="st">   # Define latent state at first capture</span></a>
<a class="sourceLine" id="cb3-76" data-line-number="76"><span class="st">   z[i,f[i]] &lt;- y[i,f[i]]</span></a>
<a class="sourceLine" id="cb3-77" data-line-number="77"><span class="st">   for (t in (f[i]+1):n.occasions){</span></a>
<a class="sourceLine" id="cb3-78" data-line-number="78"><span class="st">      # State process: draw S(t) given S(t-1)</span></a>
<a class="sourceLine" id="cb3-79" data-line-number="79"><span class="st">      z[i,t] ~ dcat(ps[z[i,t-1], t-1,])</span></a>
<a class="sourceLine" id="cb3-80" data-line-number="80"><span class="st">      # Observation process: draw O(t) given S(t)</span></a>
<a class="sourceLine" id="cb3-81" data-line-number="81"><span class="st">      y[i,t] ~ dcat(po[z[i,t], t-1,])</span></a>
<a class="sourceLine" id="cb3-82" data-line-number="82"><span class="st">      } #t</span></a>
<a class="sourceLine" id="cb3-83" data-line-number="83"><span class="st">   } #i</span></a>
<a class="sourceLine" id="cb3-84" data-line-number="84"><span class="st">}</span></a>
<a class="sourceLine" id="cb3-85" data-line-number="85"><span class="st">"</span>,<span class="dt">fill=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-86" data-line-number="86"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>()</a></code></pre></div>
<div id="fitting-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-the-model" class="anchor"></a>Fitting the model</h3>
<p>Multi-state models can be very computationally expensive. One way to speed them up is the provide the latent matrix <code>z</code> as partially-observed data. When the individual is seen, we know <span class="math inline">\(z\)</span>. When the individual is not seen, we don’t know the state so we code that as <code>z = NA</code>. The following function will take the observed capture history and create a matrix <code>z</code> with the partially-known states:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">known.state.ms &lt;-<span class="st"> </span><span class="cf">function</span>(ms, notseen){</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="co"># notseen: label for not seen</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  state &lt;-<span class="st"> </span>ms</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  state[state<span class="op">==</span>notseen] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(ms)[<span class="dv">1</span>]){</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    m &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(state[i,])))</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    state[i,m] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(state)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">}</a></code></pre></div>
<p>We can also define a function to create initial values for <code>z</code> and thereby avoid the dreaded <code>Invalid parent node</code> error:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># Function to create initial values for unknown z</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">ms.init.z &lt;-<span class="st"> </span><span class="cf">function</span>(ch, f){</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(ch)[<span class="dv">1</span>]){ch[i,<span class="dv">1</span><span class="op">:</span>f[i]] &lt;-<span class="st"> </span><span class="ot">NA</span>}</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  states &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(ch, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  known.states &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>(states<span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  v &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(ch<span class="op">==</span>states)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  ch[<span class="op">-</span>v] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  ch[v] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(known.states, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(v), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(ch)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">}</a></code></pre></div>
<p>Now bundle the data and set the MCMC settings. Currently, <code>ni</code> and <code>nb</code> are set very low. This model takes a long time to run so these settings will allow us to work out any bugs without having to wait a long time to see the error message. Once you have the model running, increase these values to, say, 50,000 and 10,000:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Bundle data</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> rCH, <span class="dt">f =</span> f, <span class="dt">n.occasions =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(rCH)[<span class="dv">2</span>], <span class="dt">nind =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(rCH)[<span class="dv">1</span>], <span class="dt">z =</span> <span class="kw">known.state.ms</span>(rCH, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># Initial values</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># Need 1 value of s for each occasion</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">s =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(rCH)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">z =</span> <span class="kw">ms.init.z</span>(rCH, f))}  </a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co"># Parameters monitored</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">parameters &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"s"</span>, <span class="st">"psiV"</span>, <span class="st">"psiF"</span>, <span class="st">"psiD"</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co"># MCMC settings (change these once you know the model is running)</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">ni &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">nt &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">nb &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">nc &lt;-<span class="st"> </span><span class="dv">3</span></a></code></pre></div>
<p>Finally, fit the model:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># Call JAGS from R</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">fit &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(<span class="dt">data =</span> jags.data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> parameters, </a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                        <span class="dt">model.file =</span> here<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"jags/ladyslipper.jags"</span>), </a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                        <span class="dt">n.chains =</span> nc, <span class="dt">n.thin =</span> nt, <span class="dt">n.iter =</span> ni, <span class="dt">n.burnin =</span> nb, </a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                        <span class="dt">parallel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(fit, <span class="dt">digits =</span> <span class="dv">3</span>)</a></code></pre></div>
<p>Be sure to check the model for convergence and to determine whether the parameter estimates are consistent with the data generating values.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#reading-in-the-data">Reading in the data</a></li>
      <li><a href="#the-model">The model</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.2.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
