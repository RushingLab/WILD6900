<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metroplis sampler for a simple linear regression • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Metroplis sampler for a simple linear regression">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2019.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
    <li>
      <a href="../articles/Lecture10/Lecture10.html">Lecture 10: Estimating abundance: N-mixture models</a>
    </li>
    <li>
      <a href="../articles/Lecture11/Lecture11.html">Lecture 11: Estimating abundance: Hierarchical distance sampling</a>
    </li>
    <li>
      <a href="../articles/Lecture12/Lecture12.html">Lecture 12: Estimating abundance: Occupancy modeling</a>
    </li>
    <li>
      <a href="../articles/Lecture13/Lecture13.html">Lecture 13: Estimating abundance: Closed-population capture-mark-recapture</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
    <li>
      <a href="../articles/n-mixture1.html">Introduction to N-mixture models</a>
    </li>
    <li>
      <a href="../articles/n-mixture2.html">Advanced N-mixture models: Zero-inflation and posterior predictive checks</a>
    </li>
    <li>
      <a href="../articles/multi_spp_occ.html">Estimating species richness using hierarchical occupancy models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Metroplis sampler for a simple linear regression</h1>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2019-04-08</h4>
      
      
      <div class="hidden name"><code>metropolis.Rmd</code></div>

    </div>

    
    
<p>In this activity, we will use <code>R</code> to create a simple Metroplis sampler to estimate the posterior distributions of the parameters in a linear regression model. This example is slightly more complicated than the sampler we developed during lecture because instead of estimating the posterior distribution for a single parameter, we have to create a sampler that iterates the MCMC steps over multiple parameters. However, as you will see, this is not so hard. To check that the sampler does what we want it to do, we will use the simulated data we created in the <a href="https://rushinglab.github.io/WILD6900/articles/simulation.html">previous activity</a> as input for the sampler and check that the posterior distributions match the data-generating parameters.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Create a Metroplis sampler to estimate the parameters of a linear regression model</p></li>
<li><p>Create custom functions to avoid copying/pasting code</p></li>
<li>
<code>R</code> functions used in this exercise:
<ul>
<li><code><a href="https://www.rdocumentation.org/packages/base/topics/source">source()</a></code></li>
<li><code><a href="https://dplyr.tidyverse.org/reference/slice.html">dplyr::slice()</a></code></li>
</ul>
</li>
</ul>
<hr>
<div id="markov-chain-monte-carlo" class="section level1">
<h1 class="hasAnchor">
<a href="#markov-chain-monte-carlo" class="anchor"></a>Markov chain Monte Carlo</h1>
<p>In lecture, we learned the basic steps of the Metropolis sampler:</p>
<ol start="0" style="list-style-type: decimal">
<li><p>Choose an initial value for <span class="math inline">\(\theta\)</span> (call it <span class="math inline">\(\theta^1\)</span>)</p></li>
<li><p>Propose a new value <span class="math inline">\(\theta^*\)</span> from a proposal distribution</p></li>
<li><p>Compute the probability of accepting <span class="math inline">\(\theta^*\)</span> using the joint distributions evaluated at <span class="math inline">\(\theta^*\)</span> and the previous value <span class="math inline">\(\theta^{k-1}\)</span></p></li>
<li><p>Accept <span class="math inline">\(\theta*\)</span> (i.e., <span class="math inline">\(\theta^{k} = \theta^*\)</span>) with the probability estimated in step 2, otherwise retain the previous value (i.e., <span class="math inline">\(\theta^{k} = \theta^{k-1}\)</span></p></li>
</ol>
</div>
<div id="seed-count-model" class="section level1">
<h1 class="hasAnchor">
<a href="#seed-count-model" class="anchor"></a>Seed count model</h1>
<p>When we generated the seed count data, we did so assuming a linear model that linked pollination visits to seed counts:</p>
<p><span class="math display">\[y_i = \alpha + \beta * x_i + \epsilon_i\]</span> <span class="math display">\[\epsilon_i \sim Normal(0, \sigma^2)\]</span></p>
<p>This model includes 3 random variables that we want to estimate posterior distributions for: <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma^2\)</span> (remember that the <span class="math inline">\(y_i\)</span> and <span class="math inline">\(x_i\)</span> are <em>observed</em> and therefore treated as <em>fixed</em> and <em>known</em> rather than random variables governed by probability distrubtions). So:</p>
<p><span class="math display">\[[\alpha, \beta, \sigma^2|y_i] \propto [y_i|\alpha, \beta, \sigma^2][\alpha][\beta][\sigma^2] \tag{1}\]</span></p>
<p>Sticking with the data generating model, we can define the likelihood of our model using a Normal distribution. For given values of <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma^2\)</span>, we estimate the likelihood as:</p>
<p><span class="math display">\[[y_i|\alpha, \beta, \tau] = \prod_{i=1}^N Normal(y_i|\alpha + \beta \times x_i, \sigma^2)\]</span></p>
<p>Because <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma^2\)</span> are random variables, we must define prior distributions for them. Because <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> can be positive or negative real numbers (we’ll ignore for now that we know the sign of each in our data generating model), we can use normal priors:</p>
<p><span class="math display">\[[\alpha] = Normal(\alpha|0, 50)\]</span></p>
<p><span class="math display">\[[\beta] = Normal(\beta|0, 50)\]</span></p>
<p>These are relatively non-informative priors for the intercept and slope coefficients.</p>
<p>We will slightly modify the model for <span class="math inline">\(\sigma^2\)</span> to be consistent with the way JAGS parameterizes normal distributions. Instead of modeling the variance (<span class="math inline">\(\sigma^2\)</span>) as a random variable, we will model the precision (<span class="math inline">\(\tau\)</span>) noting that:</p>
<p><span class="math display">\[\tau = \frac{1}{\sigma^2}\]</span></p>
<p>This is a little confusing if you are used to working with standard deviations or variances but as you will see, we can easily switch back and forth between the two when we create the model. For <span class="math inline">\(\tau\)</span>, we will use a relatively diffuse gamma prior:</p>
<p><span class="math display">\[[\tau] = Gamma(\tau|0.01, 0.01)\]</span></p>
</div>
<div id="custom-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#custom-functions" class="anchor"></a>Custom functions</h1>
<p>At each interation of the sampler, we will need to perform the same set of tasks, namely estimating the likelihood and joint distributions for the proposed and current parameter values. We could do this by copying and pasting the code necessary for these calculations at each point in the sampler code where we need them. However, any time you find yourself copying and pasting the same code more than once or twice, it’s a good idea to consider wrapping that code in a function, which will do here.</p>
<div id="function-for-calculating-likelihood" class="section level2">
<h2 class="hasAnchor">
<a href="#function-for-calculating-likelihood" class="anchor"></a>Function for calculating likelihood</h2>
<p>Given values of <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\tau\)</span>, we can estimate the likelihood in <code>R</code> using the <code><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm()</a></code> function (note that we will take the sum of the log likelihoods rather than the product of the likelihoods to avoid numerical issues):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convert precision into standard deviation</span>
  sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau)   

<span class="co"># Calculate the predicted count for each flower</span>
  lp &lt;-<span class="st"> </span>alpha <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>x  
  
<span class="co"># Calculate the likelihood of our data given the model</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(y, lp, sigma, <span class="dt">log =</span> <span class="ot">TRUE</span>)) </code></pre></div>
<p>To turn this code into a function, first open a new script and call it <code>calc_like.R</code>. Save it in the <code>R/</code> sub-directory. This script will contain the fuction code. The function code is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">calc_like &lt;-<span class="st"> </span><span class="cf">function</span>(y, alpha, beta, tau, x) {
  sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau)
  lp &lt;-<span class="st"> </span>alpha <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>x
  ll &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(y, lp, sigma, <span class="dt">log =</span> <span class="ot">TRUE</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(ll)
}</code></pre></div>
<p>This allows us to put in the data (<code>y</code>), covariate values (<code>x</code>), and values of <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\tau\)</span> as arguments and the function will return the log likelihood.</p>
<p>Save this code in the script and then close the script.</p>
</div>
<div id="functions-for-calculating-prior-probabilities" class="section level2">
<h2 class="hasAnchor">
<a href="#functions-for-calculating-prior-probabilities" class="anchor"></a>Functions for calculating prior probabilities</h2>
<p>We also need functions to estimate the prior probabilities for specific values of <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\tau\)</span>. Create a new script titled <code>priors.R</code> and save it to the <code>R/</code> sub-directory. The following functions will take values of each parameter and estimate the prior probability given the prior distributions we defined above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">priorAlpha &lt;-<span class="st"> </span><span class="cf">function</span>(alpha, <span class="dt">mu =</span> <span class="dv">0</span>, <span class="dt">tau =</span> <span class="fl">0.001</span>){
  sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau)
  prob &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(alpha, mu, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau), <span class="dt">log =</span> <span class="ot">TRUE</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(prob)
} 

priorBeta &lt;-<span class="st"> </span><span class="cf">function</span>(beta, <span class="dt">mu =</span> <span class="dv">0</span>, <span class="dt">tau =</span> <span class="fl">0.001</span>){
  sigma &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau)
  prob &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(beta, mu, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau), <span class="dt">log =</span> <span class="ot">TRUE</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(prob)
} 

priorTau &lt;-<span class="st"> </span><span class="cf">function</span>(tau, <span class="dt">shape1 =</span> <span class="fl">0.01</span>, <span class="dt">rate1 =</span> <span class="fl">0.01</span>){
  prob &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">dgamma</a></span>(tau, <span class="dt">shape =</span> shape1, <span class="dt">rate =</span> rate1, <span class="dt">log =</span> <span class="ot">TRUE</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(prob)
} </code></pre></div>
</div>
<div id="metropolis-sampler" class="section level2">
<h2 class="hasAnchor">
<a href="#metropolis-sampler" class="anchor"></a>Metropolis sampler</h2>
<p>Now we are ready to create the sampler. Remember that when there are mutiple parameters, we need to define the full conditionals. For each random variable in the model, we define the full conditional by including any element on the right hand side of eq. 1 that contains the parameter (note the change to <span class="math inline">\(\tau\)</span>):</p>
<p><span class="math display">\[[\alpha|.] = [y_i|\alpha, \beta, \tau][\alpha]\]</span> <span class="math display">\[[\beta|.] = [y_i|\alpha, \beta, \tau][\beta]\]</span></p>
<p><span class="math display">\[[\tau|.] = [y_i|\alpha, \beta, \tau][\tau]\]</span></p>
<p>In the sampler, we loop over each parameter, going through the Metroplis steps for each and treating the other parameters as known (based on their current value in the chain). If this in not clear, walking through the <code>R</code> code will hopefully make it more concrete (don’t worry about trying to copy and run the code in this section, which is simply for illustration. In the next section, we will <em>slightly</em> modify this code to run the sampler for our seed count data).</p>
<p>First, we set the length of our chains, set the tuning parameter for the proposal distribution, and create an empty data frame to store the samples and a binary variable for estimating the acceptance rate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Length of chains
  nIter &lt;-<span class="st"> </span><span class="dv">10000</span>

## Tuning parameter
  tuning &lt;-<span class="st"> </span><span class="fl">1.5</span>

## Empty data frame to store posterior samples of each parameter
  mcmc_df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span>nIter,
                        <span class="dt">alpha =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">beta =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">tau =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">alpha.accept =</span> <span class="dv">0</span>,
                        <span class="dt">beta.accept =</span> <span class="dv">0</span>
                        <span class="dt">tau.accept =</span> <span class="dv">0</span>)</code></pre></div>
<p>Next, we will randomly generate initial values for each parameter. Remember that these are quite big numbers in the data generating model so we will create initial values of the same magnitude:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Initial values
  mcmc_df<span class="op">$</span>alpha[<span class="dv">1</span>] &lt;-<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">200</span>, <span class="dv">300</span>)
  mcmc_df<span class="op">$</span>beta[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">25</span>, <span class="dv">75</span>)
  mcmc_df<span class="op">$</span>tau[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>)</code></pre></div>
<p>The final “set up” step is to estimate the likelihood of our data given these initial values. To do this, we use the <code>calc_like()</code> function we created earlier:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Initial likelihood
likelihood &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[<span class="dv">1</span>], 
                       <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[<span class="dv">1</span>], <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[<span class="dv">1</span>], 
                       <span class="dt">x =</span> x) </code></pre></div>
<p>Now we create the actual sampler. Below, we will create a loop that implements these steps for each iteration of the chains. Here, we will simply go through each step to make sure you understand what it’s doing. We’ll start by going through the Metropolis steps for <span class="math inline">\(\alpha\)</span> (though remember the order doesn’t matter):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">########################
#### 1. Update alpha
########################

## 1a: Generate candidate value
  cand &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, mcmc_df<span class="op">$</span>alpha[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>], tuning)

## 1b: Calculate likelihood at candidate value
  cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> y, <span class="dt">alpha =</span> cand, <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>], <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>], <span class="dt">x =</span> x)
  
## 1c: Calculate likelihood * prior at old value and candidate value
  jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorAlpha</span>(mcmc_df<span class="op">$</span>alpha[i<span class="op">-</span><span class="dv">1</span>]) 
  jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorAlpha</span>(cand) 
  
## 1d: Acceptance probability 
  R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 1e: Decide whether to accept or not
  <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
      mcmc_df<span class="op">$</span>alpha[i] &lt;-<span class="st"> </span>cand
      likelihood &lt;-<span class="st"> </span>cand_like
    } <span class="cf">else</span> {
      mcmc_df<span class="op">$</span>alpha[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>alpha[i<span class="op">-</span><span class="dv">1</span>]
  }</code></pre></div>
<p>Let’s go through this line by line. In <code>step 1a</code>, we generate a new value of <span class="math inline">\(\alpha\)</span> from a normal distribution centered on the previous value. Remember that the tuning parameter we set earlier determines how big the jumps are between the current and proposed values.</p>
<p>In <code>step 1b</code>, we use the <code>calc_like()</code> function to estimate the likelihood of our data given the new value of <span class="math inline">\(\alpha\)</span> and the previous values of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\tau\)</span>. This is what we mean when we say that we treat the other parameters as <em>fixed</em> and <em>known</em>.</p>
<p>In <code>step 1c</code>, we estimate the joint probability of both the current and proposed values by adding the log likelihood to the log prior probability (note that sum of the log values is the same as the product of the probabilities).</p>
<p>In <code>step 1d</code>, we estimate the probability of accepting the new value. Note that if the proposed value is more likely than the current value (<span class="math inline">\(R &gt; 1\)</span>), this function will return 1. Otherwise, it returns the ratio. The closer the joint probabilities are, the closer <span class="math inline">\(R\)</span> will be to 1. The less likely the proposed value is relative to the current value, the smaller <span class="math inline">\(R\)</span> will be. This means that we will be much less likely to accept new values of <span class="math inline">\(\alpha\)</span> that are a lot less probable than the current value (though not impossible).</p>
<p>Finally, in <code>step 1e</code> we accept or reject the proposed value. Note that we compare <span class="math inline">\(R\)</span> to a random value generated from a <span class="math inline">\(Uniform(0,1)\)</span> distribution. If <span class="math inline">\(R=1\)</span>, it will always be greater than this value so we will always accept the proposed value (<code>mcmc_df$alpha[i] &lt;- cand</code>) and we update the current likelihood to match the current value of <span class="math inline">\(\alpha\)</span>. If <span class="math inline">\(R&lt;1\)</span>, it turns out testing whether <span class="math inline">\(R\)</span> is less than our randomly generated value from <span class="math inline">\(Uniform(0,1)\)</span> ensures that we accept <span class="math inline">\(\alpha\)</span> with probability <span class="math inline">\(R\)</span> (I’ll leave it to you to prove this based on the properties of the uniform distribution).</p>
<p>Next we do the same thing for <span class="math inline">\(\beta\)</span>, using the new value of <span class="math inline">\(alpha\)</span> (<code>mcmc_df$alpha[i]</code>) and the previous value of <span class="math inline">\(\tau\)</span> (<code>mcmc_df$tau[i - 1]</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">########################
#### 2. Update beta
########################

## 2a: Generate candidate value
  cand &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, mcmc_df<span class="op">$</span>beta[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>], tuning)

## 2b: Calculate likelihood at candidate value
  cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[i], <span class="dt">beta =</span> cand, 
                         <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>], <span class="dt">x =</span> x)
  
## 2c: Calculate likelihood * prior at old value and candidate value
  jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorBeta</span>(mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>]) 
  jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorBeta</span>(cand) 
  
## 2d: Acceptance probability 
  R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 2e: Decide whether to accept or not
  <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
      mcmc_df<span class="op">$</span>beta[i] &lt;-<span class="st"> </span>cand
      likelihood &lt;-<span class="st"> </span>cand_like
    } <span class="cf">else</span> {
      mcmc_df<span class="op">$</span>beta[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>]
    }</code></pre></div>
<p>Finally, we update <span class="math inline">\(\tau\)</span> using the new values of both <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>. The only difference here is that because <span class="math inline">\(\tau\)</span> has to be <span class="math inline">\(&gt;0\)</span>, the normal proposal distrbution we used for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> will not work (it could create negative values). As we learned in lecture, you could create a proposal distribution that generates positive value (e.g., gamma) and use moment matching to estimate the parameters with regards to the current <span class="math inline">\(\tau\)</span> and the tuning parameter. We’ll use a slightly less efficient approach here to demonstrate there are different ways to enforcing the behavior we want in the sampler. In this cases, will simply add a small value to the current <span class="math inline">\(\tau\)</span> and automatically reject the proposed value if it’s less than 0. The small value can be negative or positive to allow us to explore the posterior.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">########################
#### 3. Update tau
########################

## 3a: Generate candidate value
    cand &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>,  <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>)
    <span class="co"># If candidate value is outside [0,Inf], keep the old value of tau</span>
    <span class="cf">if</span> (cand <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {
      mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>]
    } <span class="cf">else</span> {
## 3b: Calculate likelihood at candidate value
      cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[i], <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[i], 
                          <span class="dt">tau =</span> cand, <span class="dt">x =</span> x)
      
## 3c: Calculate likelihood * prior at old value and candidate value
      jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorTau</span>(mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>])
      jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorTau</span>(cand)

## 3d: Acceptance probability 
      R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 3e: Decide whether to accept or not
      <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
        mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>cand
        likelihood &lt;-<span class="st"> </span>cand_like
      } <span class="cf">else</span> {
        mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>]
      }
    }
  <span class="er">}</span></code></pre></div>
</div>
</div>
<div id="running-the-sampler" class="section level1">
<h1 class="hasAnchor">
<a href="#running-the-sampler" class="anchor"></a>Running the sampler</h1>
<p>Finally, we can run the sampler. Create a new script called <code>metroplis.R</code> (or something similar) and put it in <code>scripts/</code>. First, we will load the packages we need and use the <code><a href="https://www.rdocumentation.org/packages/base/topics/source">source()</a></code> function to read in our custom functions (<code><a href="https://www.rdocumentation.org/packages/base/topics/source">source()</a></code> runs the <code>.R</code> files given in the argument which in this case will make the functions available for our sampler):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(WILD6900)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/source">source</a></span>(<span class="st">"R/calc_like.R"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/source">source</a></span>(<span class="st">"R/priors.R"</span>)</code></pre></div>
<p>Next, read in the simulated data and set the initial values for the MCMC:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Read simulated data
  sim_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(<span class="st">"data/sim_seed_counts.rds"</span>)

## Length of chains
  nIter &lt;-<span class="st"> </span><span class="dv">10000</span>

## Tuning parameter
  tuning &lt;-<span class="st"> </span><span class="fl">1.5</span>

## Empty data frame to store posterior samples of each parameter
  mcmc_df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span>nIter,
                        <span class="dt">alpha =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">beta =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">tau =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nIter),
                        <span class="dt">accept.alpha =</span> <span class="dv">0</span>,
                        <span class="dt">accept.beta =</span> <span class="dv">0</span>, 
                        <span class="dt">accept.tau =</span> <span class="dv">0</span>)

## Initial values
  mcmc_df<span class="op">$</span>alpha[<span class="dv">1</span>] &lt;-<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">200</span>, <span class="dv">300</span>)
  mcmc_df<span class="op">$</span>beta[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">25</span>, <span class="dv">75</span>)
  mcmc_df<span class="op">$</span>tau[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)
  
## Initial likelihood
  likelihood &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> sim_dat<span class="op">$</span>y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[<span class="dv">1</span>], 
                       <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[<span class="dv">1</span>], <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[<span class="dv">1</span>], 
                       <span class="dt">x =</span> sim_dat<span class="op">$</span>visits.c) </code></pre></div>
<p>Now take the sampler code and put it inside a <code>for</code> loop to create the chains. Note that in the likelihood functions we will need to reference our simulated data and covariates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>nIter){
########################
#### 1. Update alpha
########################

## 1a: Generate candidate value
  cand &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, mcmc_df<span class="op">$</span>alpha[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>], tuning)

## 1b: Calculate likelihood at candidate value
  cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> sim_dat<span class="op">$</span>y, <span class="dt">alpha =</span> cand, 
                         <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>], <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>], 
                         <span class="dt">x =</span> sim_dat<span class="op">$</span>visits.c)
  
## 1c: Calculate likelihood * prior at old value and candidate value
  jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorAlpha</span>(mcmc_df<span class="op">$</span>alpha[i<span class="op">-</span><span class="dv">1</span>]) 
  jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorAlpha</span>(cand) 
  
## 1d: Acceptance probability 
  R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 1e: Decide whether to accept or not
  <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
      mcmc_df<span class="op">$</span>alpha[i] &lt;-<span class="st"> </span>cand
      likelihood &lt;-<span class="st"> </span>cand_like
      mcmc_df<span class="op">$</span>accept.alpha[i] &lt;-<span class="st"> </span><span class="dv">1</span>
    } <span class="cf">else</span> {
      mcmc_df<span class="op">$</span>alpha[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>alpha[i<span class="op">-</span><span class="dv">1</span>]
    }
  
########################
#### 2. Update beta
########################

## 2a: Generate candidate value
  cand &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, mcmc_df<span class="op">$</span>beta[i <span class="op">-</span><span class="st"> </span><span class="dv">1</span>], tuning)

## 2b: Calculate likelihood at candidate value
  cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> sim_dat<span class="op">$</span>y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[i], <span class="dt">beta =</span> cand, 
                         <span class="dt">tau =</span> mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>], <span class="dt">x =</span> sim_dat<span class="op">$</span>visits.c)
  
## 2c: Calculate likelihood * prior at old value and candidate value
  jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorBeta</span>(mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>]) 
  jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorBeta</span>(cand) 
  
## 2d: Acceptance probability 
  R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 2e: Decide whether to accept or not
  <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
      mcmc_df<span class="op">$</span>beta[i] &lt;-<span class="st"> </span>cand
      likelihood &lt;-<span class="st"> </span>cand_like
      mcmc_df<span class="op">$</span>accept.beta[i] &lt;-<span class="st"> </span><span class="dv">1</span>
    } <span class="cf">else</span> {
      mcmc_df<span class="op">$</span>beta[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>beta[i<span class="op">-</span><span class="dv">1</span>]
    }
  
########################
#### 3. Update tau
########################

## 3a: Generate candidate value
    cand &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>,  <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.01</span>)
    <span class="co"># If candidate value is outside [0,Inf], keep the old value of tau</span>
    <span class="cf">if</span> (cand <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {
      mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>]
    } <span class="cf">else</span> {
## 3b: Calculate likelihood at candidate value
      cand_like &lt;-<span class="st"> </span><span class="kw">calc_like</span>(<span class="dt">y =</span> sim_dat<span class="op">$</span>y, <span class="dt">alpha =</span> mcmc_df<span class="op">$</span>alpha[i], <span class="dt">beta =</span> mcmc_df<span class="op">$</span>beta[i], 
                          <span class="dt">tau =</span> cand, <span class="dt">x =</span> sim_dat<span class="op">$</span>visits.c)
      
## 3c: Calculate likelihood * prior at old value and candidate value
      jointOld &lt;-<span class="st"> </span>likelihood <span class="op">+</span><span class="st"> </span><span class="kw">priorTau</span>(mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>])
      jointCand &lt;-<span class="st"> </span>cand_like <span class="op">+</span><span class="st"> </span><span class="kw">priorTau</span>(cand)

## 3d: Acceptance probability 
      R &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(jointCand <span class="op">-</span><span class="st"> </span>jointOld))

## 3e: Decide whether to accept or not
      <span class="cf">if</span>(R <span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)) {   <span class="co"># if accepted</span>
        mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>cand
        likelihood &lt;-<span class="st"> </span>cand_like
        mcmc_df<span class="op">$</span>accept.tau[i] &lt;-<span class="st"> </span><span class="dv">1</span>
      } <span class="cf">else</span> {
        mcmc_df<span class="op">$</span>tau[i] &lt;-<span class="st"> </span>mcmc_df<span class="op">$</span>tau[i<span class="op">-</span><span class="dv">1</span>]
      }
    }
}</code></pre></div>
<p>At this point, you should be able to run the script from start to finish and create the posterior samples for each parameter.</p>
</div>
<div id="checking-the-output" class="section level1">
<h1 class="hasAnchor">
<a href="#checking-the-output" class="anchor"></a>Checking the output</h1>
<p>Now we can determine whether the sampler returns the data generating values from our data simulation. When assessing the output of MCMC chains, a good first diagnostic is usually checking the traceplots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(mcmc_df, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> alpha)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<p><img src="metropolis_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The chain for <span class="math inline">\(\alpha\)</span> moved rapidly from the initial value to the stationary posterior distribution but those first few samples will obviously bias our parameter estimates if we include them in the posterior. Let’s remove them by using the <code>dplyr</code> function <code>slice()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mcmc_df &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span>(mcmc_df, <span class="dv">1000</span><span class="op">:</span>nIter)

<span class="kw">ggplot</span>(mcmc_df, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> alpha)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<p><img src="metropolis_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;"></p>
<p>That looks better. Now we can estimate the mean and 95% credible interval of the posterior:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(mcmc_df<span class="op">$</span>alpha)
<span class="co">#&gt; [1] 249.3</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(mcmc_df<span class="op">$</span>alpha, <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))
<span class="co">#&gt;  2.5% 97.5% </span>
<span class="co">#&gt; 248.1 250.5</span></code></pre></div>
<p>Pretty close to the data generating value of 250. Now let’s check <span class="math inline">\(\beta\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(mcmc_df, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> beta)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<p><img src="metropolis_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;"></p>
<p>and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(mcmc_df<span class="op">$</span>beta)
<span class="co">#&gt; [1] 50.63</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(mcmc_df<span class="op">$</span>beta, <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))
<span class="co">#&gt;  2.5% 97.5% </span>
<span class="co">#&gt; 49.47 51.79</span></code></pre></div>
<p>Also pretty close to the data generating value of 50. Finally, <span class="math inline">\(\tau\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(mcmc_df, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> tau)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<p><img src="metropolis_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(mcmc_df<span class="op">$</span>tau)
<span class="co">#&gt; [1] 0.01642</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(mcmc_df<span class="op">$</span>tau, <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))
<span class="co">#&gt;    2.5%   97.5% </span>
<span class="co">#&gt; 0.01313 0.02017</span></code></pre></div>
<p>The chain looks like it converged on a stationary distribution but what was the data generating value? Remember that we parameterized the simulated data in terms of the standard deviation, which was 7.5. Because <span class="math inline">\(\sigma = \sqrt{\frac{1}{\tau}}\)</span>, we can simply derive the posterior distribution of <span class="math inline">\(\sigma\)</span> from <span class="math inline">\(\tau\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mcmc_df &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(mcmc_df, <span class="dt">sigma =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="dv">1</span><span class="op">/</span>tau))

<span class="kw">ggplot</span>(mcmc_df, <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> sigma)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>()</code></pre></div>
<p><img src="metropolis_files/figure-html/unnamed-chunk-20-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(mcmc_df<span class="op">$</span>sigma)
<span class="co">#&gt; [1] 7.838</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/quantile">quantile</a></span>(mcmc_df<span class="op">$</span>sigma, <span class="dt">probs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))
<span class="co">#&gt;  2.5% 97.5% </span>
<span class="co">#&gt; 7.041 8.727</span></code></pre></div>
<p>Wasn’t that easy?</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#markov-chain-monte-carlo">Markov chain Monte Carlo</a></li>
      <li><a href="#seed-count-model">Seed count model</a></li>
      <li>
<a href="#custom-functions">Custom functions</a><ul class="nav nav-pills nav-stacked">
<li><a href="#function-for-calculating-likelihood">Function for calculating likelihood</a></li>
      <li><a href="#functions-for-calculating-prior-probabilities">Functions for calculating prior probabilities</a></li>
      <li><a href="#metropolis-sampler">Metropolis sampler</a></li>
      </ul>
</li>
      <li><a href="#running-the-sampler">Running the sampler</a></li>
      <li><a href="#checking-the-output">Checking the output</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
