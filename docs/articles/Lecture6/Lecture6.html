<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Lecture 6</title>
<<<<<<< HEAD
    <meta charset="utf-8">
=======
    <meta charset="utf-8" />
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
    <meta name="author" content="   WILD6900 (Spring 2020)" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="WILD6900.css" type="text/css" />
    <link rel="stylesheet" href="WILD6900-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Lecture 6
## Introduction of Bayesian analysis using JAGS
### <br/><br/><br/>WILD6900 (Spring 2020)

---




## Readings

&gt; KÃ©ry &amp; Schaub 38-40; 58-64


---
class: inverse, middle, center

# From custom MCMC to BUGS

---
## The BUGS language

#### **B**ayesian **A**nalysis **U**sing **G**ibbs **S**ampling  

--
#### Language/program invented in the 1990's by epidemiologists in Cambridge  

--
#### Later became WinBUGS  

- First customizable MCMC software  
&lt;/br&gt;

--
- Revolutionized the use of Bayesian methods in applied statistics

---
## The BUGS language

#### Since the development of WinBUGS, other Bayesian software programs have been developed:

- OpenBugs

- [JAGS](https://sourceforge.net/projects/mcmc-jags/files/)

- [Nimble](https://r-nimble.org/)

- [Stan](https://mc-stan.org/)


--
#### For the remainder of the course, we will fit models using JAGS  

- **J**ust **A**nother **G**ibbs **S**ampler  

- Uses BUGS language (easy to learn, lots of online documentation)  

- Often out-performs WinBUGS  

- Available for all operating systems

---
## The BUGS language

#### Last week, we learned how to:  

--
- Determine the *full conditional distributions* for a linear regression model  
&lt;/br&gt;

--
- Write a custom MCMC sampler to produce samples from the joint posterior distribution  


--
### Given a statistical model and user-specified prior distributions, JAGS does these steps for you! 

--
- Possible to fit arbitrarily complex models `\(^1\)`  
&lt;/br&gt;

--
- "Frees the modeler in you"  


???

`\(^1\)` remember, just because you *can* fit it doesn't mean it will return robust inferences. As we have already discussed, complex models often suffer from lack of identifiability and poor sampling of the joint posterior distribution. But, if you can write out a valid statistical model, JAGS can create a sampler and draw samples from the joint posterior distribution

---
## Running JAGS from R

### JAGS is a stand alone software program

- Can be run from GUI or command line  


--
### JAGS can also be run from `R` using the `jagsUI` package (among others)  

--
- Write model in `R` script and save as `.jags` file  
&lt;/br&gt;

--
- Provide `jagsUI` with data, initial values, and MCMC settings  
&lt;/br&gt;

--
- model run in JAGS  
&lt;/br&gt;

--
- model output brought back in to `R` for diagnostics/analysis/visualization  

---
## The BUGS language

### Very similar to `R` (but more limited)  

- Limited ability to vectorize operations  


--
### If you can write your model on the whiteboard, you can write it in JAGS

- Stochasitic relationships represented by `~`

- Deterministic relationships represented by `&lt;-`

---
## The BUGS language

### Linear regression model
&lt;br/&gt;
&lt;br/&gt;

`$$\LARGE y_i = \alpha + \beta \times x_i + \epsilon_i$$`
&lt;/br&gt;

`$$\LARGE \epsilon_i \sim Normal(0, \tau)$$`

---
## The BUGS language

### Linear regression model

&lt;br/&gt;
&lt;br/&gt;

`$$\LARGE y_i = \underbrace{\alpha + \beta \times x_i}_{Deterministic} + \underbrace{\epsilon_i}_{Stochastic}$$`


???

Remember that `\(\tau = \frac{1}{\sigma^2}\)`

---
## The BUGS language

### Linear regression model
&lt;br/&gt;
&lt;br/&gt;

`$$\underbrace{\LARGE \mu_i = \alpha + \beta \times x_i}_{Deterministic}$$`
&lt;/br&gt;

`$$\underbrace{\LARGE y_i \sim Normal(\mu_i, \tau)}_{Stochastic}$$`
&lt;/br&gt;

--

Remember that these equations define the *likelihood* of our data given values of `\(\alpha\)`, `\(\beta\)`, and `\(\tau\)`


---
## The BUGS language

### Linear regression model

To specificy a fully Bayesian model, we also need to define the priors:
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;

--


`$$\LARGE [\alpha] \sim Normal(\alpha|0, 0.001)$$`
&lt;/br&gt;

`$$\LARGE [\beta] \sim Normal(\alpha|0, 0.001)$$`
&lt;/br&gt;

`$$\LARGE [\tau] \sim Gamma(\tau|0.01, 0.01)$$`
&lt;/br&gt;

---
## The BUGS language

### Linear regression model 

```
model{
  ## Priors
    alpha ~ dnorm(0, 0.001)
    beta ~ dnorm(0, 0.001)
    tau ~ dgamma(.001,.001) # Precision
    sigma &lt;- 1/sqrt(tau)      # Calculate sd from precision
    
  ## Likelihood
    for(i in 1:N){
      mu[i] &lt;- alpha + beta * x[i]
      y[i] ~ dnorm(mu[i], tau)
    }
} #end of model
```

---
## Writing model files


```r
sink(file="jags/linear_regression.jags")
cat("
  model{
    ## Priors
    alpha ~ dnorm(0, 0.001)
    beta ~ dnorm(0, 0.001)
    tau ~ dgamma(.001,.001) # Precision
    sigma &lt;- 1/sqrt(tau)      # Calculate sd from precision
    ## Likelihood
    for(i in 1:N){
      mu[i] &lt;- alpha + beta * x[i]
      y[i] ~ dnorm(mu[i], tau)
    }
  } #end of model
    ", fill=TRUE)
sink()
```

---
## Preparing the data


```r
## Read simulated data frame
dat &lt;- readRDS("data/sim_seed_counts.rds")

## Store data for JAGS as list
jags_data &lt;- list(y = dat$y, x = dat$visits.c, N = nrow(dat))

## Create function that returns random initial values
jags_inits &lt;- function(){list(alpha = runif(1, 200, 300), 
                              beta = runif(1, 25, 75), 
                              tau = runif(1))}

## Tell JAGS which parameters we want to monitor
params &lt;- c("alpha", "beta", "tau", "sigma")
```

---
## Run the model


```r
## Run the model
jags_fit &lt;- jagsUI::jags(data = jags_data, inits = jags_inits, 
                      parameters.to.save = params, 
                      model.file = "jags/linear_regression.jags", 
                      n.chains = 3, n.iter = 10000, 
                      n.burnin = 2500, n.thin = 1)
```



---
## Diagnostics


```r
print(jags_fit)
```

```
## JAGS output for model '/Library/Frameworks/R.framework/Versions/3.6/Resources/library/WILD6900/jags/linear_regression.jags', generated by jagsUI.
## Estimates based on 3 chains of 10000 iterations,
## adaptation = 100 iterations (sufficient),
## burn-in = 2500 iterations and thin rate = 1,
## yielding 22500 total samples from the joint posterior. 
<<<<<<< HEAD
## MCMC ran for 0.012 minutes at time 2019-12-17 15:25:38.
## 
##              mean    sd     2.5%      50%    97.5% overlap0 f Rhat n.eff
## alpha     249.177 0.624  247.947  249.179  250.385    FALSE 1    1 22500
## beta       49.902 0.627   48.667   49.900   51.131    FALSE 1    1  6445
## tau         0.015 0.002    0.012    0.015    0.018    FALSE 1    1  8612
## sigma       8.251 0.446    7.430    8.232    9.184    FALSE 1    1 11151
## deviance 1234.723 2.481 1231.893 1234.096 1241.147    FALSE 1    1 13825
=======
## MCMC ran for 0.025 minutes at time 2019-12-16 16:08:08.
## 
##              mean    sd     2.5%      50%    97.5% overlap0 f Rhat n.eff
## alpha     249.169 0.628  247.929  249.170  250.395    FALSE 1    1 22500
## beta       49.898 0.625   48.669   49.894   51.122    FALSE 1    1 22500
## tau         0.015 0.002    0.012    0.015    0.018    FALSE 1    1 22500
## sigma       8.252 0.446    7.434    8.232    9.189    FALSE 1    1 22500
## deviance 1234.732 2.498 1231.899 1234.081 1241.247    FALSE 1    1 22500
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
## 
## Successful convergence based on Rhat values (all &lt; 1.1). 
## Rhat is the potential scale reduction factor (at convergence, Rhat=1). 
## For each parameter, n.eff is a crude measure of effective sample size. 
## 
## overlap0 checks if 0 falls in the parameter's 95% credible interval.
## f is the proportion of the posterior with the same sign as the mean;
## i.e., our confidence that the parameter is positive or negative.
## 
## DIC info: (pD = var(deviance)/2) 
## pD = 3.1 and DIC = 1238 
## DIC is an estimate of expected predictive error (lower is better).
```

---
## Diagnostics


```r
jagsUI::traceplot(jags_fit)
```

&lt;img src="Lecture6_files/figure-html/unnamed-chunk-6-1.png" style="display: block; margin: auto;" /&gt;&lt;img src="Lecture6_files/figure-html/unnamed-chunk-6-2.png" style="display: block; margin: auto;" /&gt;&lt;img src="Lecture6_files/figure-html/unnamed-chunk-6-3.png" style="display: block; margin: auto;" /&gt;&lt;img src="Lecture6_files/figure-html/unnamed-chunk-6-4.png" style="display: block; margin: auto;" /&gt;&lt;img src="Lecture6_files/figure-html/unnamed-chunk-6-5.png" style="display: block; margin: auto;" /&gt;


---
## Structure of the JAGS output


```r
class(jags_fit)
```

```
## [1] "jagsUI"
```

```r
names(jags_fit)
```

```
##  [1] "sims.list"   "mean"        "sd"          "q2.5"        "q25"        
##  [6] "q50"         "q75"         "q97.5"       "overlap0"    "f"          
## [11] "Rhat"        "n.eff"       "pD"          "DIC"         "summary"    
## [16] "samples"     "modfile"     "model"       "parameters"  "mcmc.info"  
## [21] "run.date"    "parallel"    "bugs.format" "calc.DIC"
```

---
## Structure of the JAGS output


```r
str(jags_fit$sims.list)
```

```
## List of 5
<<<<<<< HEAD
##  $ alpha   : num [1:22500] 249 249 249 250 249 ...
##  $ beta    : num [1:22500] 50.2 50.8 49.5 48.8 49.7 ...
##  $ tau     : num [1:22500] 0.0198 0.0171 0.016 0.015 0.0156 ...
##  $ sigma   : num [1:22500] 7.11 7.65 7.89 8.15 8.01 ...
##  $ deviance: num [1:22500] 1239 1235 1233 1236 1232 ...
=======
##  $ alpha   : num [1:22500] 250 248 248 248 249 ...
##  $ beta    : num [1:22500] 49.7 50.7 50.8 50.5 48.6 ...
##  $ tau     : num [1:22500] 0.0123 0.0191 0.0171 0.0148 0.012 ...
##  $ sigma   : num [1:22500] 9.02 7.24 7.64 8.22 9.14 ...
##  $ deviance: num [1:22500] 1236 1241 1238 1235 1240 ...
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
```

```r
head(jags_fit$sims.list$alpha)
```

```
<<<<<<< HEAD
## [1] 249.3 249.2 249.2 249.7 249.0 249.1
=======
## [1] 249.9 248.4 248.3 248.2 249.5 248.8
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
```

---
## Structure of the JAGS output


```r
jags_fit$mean$alpha
```

```
## [1] 249.2
```

```r
jags_fit$f$alpha
```

```
## [1] 1
```

---
## Structure of the JAGS output


```r
jags_fit$summary
```

```
##               mean       sd      2.5%       25%       50%       75%
<<<<<<< HEAD
## alpha    2.492e+02 0.624413 2.479e+02 2.488e+02 2.492e+02 2.496e+02
## beta     4.990e+01 0.626543 4.867e+01 4.948e+01 4.990e+01 5.032e+01
## tau      1.482e-02 0.001592 1.185e-02 1.372e-02 1.476e-02 1.586e-02
## sigma    8.251e+00 0.446219 7.430e+00 7.942e+00 8.232e+00 8.538e+00
## deviance 1.235e+03 2.481193 1.232e+03 1.233e+03 1.234e+03 1.236e+03
##              97.5% Rhat n.eff overlap0 f
## alpha    2.504e+02    1 22500        0 1
## beta     5.113e+01    1  6445        0 1
## tau      1.812e-02    1  8612        0 1
## sigma    9.184e+00    1 11151        0 1
## deviance 1.241e+03    1 13825        0 1
=======
## alpha    2.492e+02 0.628050 2.479e+02 2.488e+02 2.492e+02 2.496e+02
## beta     4.990e+01 0.624858 4.867e+01 4.948e+01 4.989e+01 5.032e+01
## tau      1.481e-02 0.001592 1.184e-02 1.372e-02 1.476e-02 1.586e-02
## sigma    8.252e+00 0.446059 7.434e+00 7.941e+00 8.232e+00 8.538e+00
## deviance 1.235e+03 2.497897 1.232e+03 1.233e+03 1.234e+03 1.236e+03
##              97.5% Rhat n.eff overlap0 f
## alpha     250.3951    1 22500        0 1
## beta       51.1221    1 22500        0 1
## tau         0.0181    1 22500        0 1
## sigma       9.1888    1 22500        0 1
## deviance 1241.2465    1 22500        0 1
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
```


---
## Structure of the JAGS output


```r
str(jags_fit$samples)
```

```
## List of 3
<<<<<<< HEAD
##  $ : 'mcmc' num [1:7500, 1:5] 249 249 249 250 249 ...
=======
##  $ : 'mcmc' num [1:7500, 1:5] 250 248 248 248 249 ...
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
##   ..- attr(*, "dimnames")=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:5] "alpha" "beta" "tau" "sigma" ...
##   ..- attr(*, "mcpar")= num [1:3] 2501 10000 1
<<<<<<< HEAD
##  $ : 'mcmc' num [1:7500, 1:5] 249 248 249 249 250 ...
=======
##  $ : 'mcmc' num [1:7500, 1:5] 250 249 250 250 250 ...
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
##   ..- attr(*, "dimnames")=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:5] "alpha" "beta" "tau" "sigma" ...
##   ..- attr(*, "mcpar")= num [1:3] 2501 10000 1
<<<<<<< HEAD
##  $ : 'mcmc' num [1:7500, 1:5] 249 250 250 250 250 ...
=======
##  $ : 'mcmc' num [1:7500, 1:5] 249 248 249 248 249 ...
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
##   ..- attr(*, "dimnames")=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:5] "alpha" "beta" "tau" "sigma" ...
##   ..- attr(*, "mcpar")= num [1:3] 2501 10000 1
##  - attr(*, "class")= chr "mcmc.list"
```

---
## Structure of the JAGS output


```r
str(jags_fit$mcmc.info)
```

```
## List of 9
##  $ n.chains        : num 3
##  $ n.adapt         : num 100
##  $ sufficient.adapt: logi TRUE
##  $ n.iter          : num 10000
##  $ n.burnin        : num 2500
##  $ n.thin          : num 1
##  $ n.samples       : num 22500
##  $ end.values      :List of 3
<<<<<<< HEAD
##   ..$ : Named num [1:5] 2.49e+02 5.06e+01 1.23e+03 7.71 1.68e-02
##   .. ..- attr(*, "names")= chr [1:5] "alpha" "beta" "deviance" "sigma" ...
##   ..$ : Named num [1:5] 2.49e+02 4.94e+01 1.23e+03 8.02 1.55e-02
##   .. ..- attr(*, "names")= chr [1:5] "alpha" "beta" "deviance" "sigma" ...
##   ..$ : Named num [1:5] 2.48e+02 4.98e+01 1.24e+03 9.37 1.14e-02
=======
##   ..$ : Named num [1:5] 2.48e+02 4.95e+01 1.24e+03 7.73 1.67e-02
##   .. ..- attr(*, "names")= chr [1:5] "alpha" "beta" "deviance" "sigma" ...
##   ..$ : Named num [1:5] 2.48e+02 5.08e+01 1.24e+03 8.24 1.47e-02
##   .. ..- attr(*, "names")= chr [1:5] "alpha" "beta" "deviance" "sigma" ...
##   ..$ : Named num [1:5] 249.358 49.756 1233.225 7.669 0.017
>>>>>>> 6c0a4057b66735eed317af2bfc1e5b76431fa2d2
##   .. ..- attr(*, "names")= chr [1:5] "alpha" "beta" "deviance" "sigma" ...
##  $ elapsed.mins    : num 0.025
```

---
## Saving model output


```r
saveRDS(jags_fit, "output/regression_out.rds")
```
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
