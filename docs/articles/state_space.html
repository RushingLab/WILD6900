<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting state-space abundance models in JAGS • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting state-space abundance models in JAGS">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2019.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Fitting state-space abundance models in JAGS</h1>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2019-03-02</h4>
      
      
      <div class="hidden name"><code>state_space.Rmd</code></div>

    </div>

    
    
<p>As we learned in <a href="https://rushinglab.github.io/WILD6900/articles/Lecture9/Lecture9.html#1">lecture</a>, state-space models provide a flexible framework for decomposing time series data into process variation and observation error. In this lab, we will use JAGS to fit a variety of state-space models using both simulated and real data.</p>
<hr>
<p><strong>Objectives</strong></p>
<ul>
<li><p>Simulate data sets with separate process and observation models</p></li>
<li><p>Fit state-space models to count data</p></li>
<li><p>Understand when and why state-space models produce biased estimates of abundance</p></li>
</ul>
<hr>
<div id="fitting-state-space-models-to-simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-state-space-models-to-simulated-data" class="anchor"></a>Fitting state-space models to simulated data</h2>
<p>We will start this lab with a relatively simple state-space abundance model. One of the most basic population growth models is:</p>
<p><span class="math display">\[\Large N_{t+1} = N_t \times \lambda_t \tag{1}\]</span></p>
<p>where <span class="math inline">\(\lambda_t\)</span> is the change in population size from year <span class="math inline">\(t\)</span> to year <span class="math inline">\(t+1\)</span>. Values of <span class="math inline">\(\lambda_t &gt; 1\)</span> result in positive population growth whereas values of <span class="math inline">\(\lambda_t &lt; 1\)</span> result in negative population growth (you can see this by recognizing that <span class="math inline">\(\lambda_t = \frac{N_{t+1}}{N_t}\)</span>).</p>
<p>We will also assume that counts of population size are equally likely to overestimate (false positives) as they are to underestimate (false negative) the true abundance. Therefore, we will model the observed counts as:</p>
<p><span class="math display">\[\Large y_t \sim normal(N_t, \tau_{Obs}) \tag{2}\]</span></p>
<p>Our primary objective is to estimate both the annual <span class="math inline">\(\lambda_t\)</span> values as well as the overall mean population growth rate <span class="math inline">\(\mu_{\lambda}\)</span>. As you will see, one benefit of the state-space model is that we can also obtain posterior distributions for the partially-observed <span class="math inline">\(N_t\)</span> values.</p>
<p>The state-space model we just outlined is a hierarchical model <span class="math inline">\(-\)</span> <span class="math inline">\(N_t\)</span> shows up on both the LHS of equation 1 and the RHS of equation 2. We will add a second level of hierarchy by treating the annual growth rates as random effects:</p>
<p><span class="math display">\[\Large \lambda_t \sim normal(\mu_{\lambda}, \tau_{\lambda})\]</span></p>
<p>As you will see, this will result in some smoothing of the process model (the <span class="math inline">\(N_t\)</span>) relative to the raw counts because the <span class="math inline">\(\lambda_t\)</span> values (and therefore the <span class="math inline">\(N_t\)</span>) associated extremely high or low counts will be “shrunk” towards <span class="math inline">\(\mu_{\lambda}\)</span>. This formulation also has the benefit of treating the mean growth rate as a parameter in the model, allowing us to easily obtain estimates of this important parameter.</p>
<p>So far, we have identified a number of parameters in the model, each of which requires a posterior distribution:</p>
<ul>
<li><p><span class="math inline">\(\Large \lambda_t \sim normal(\mu_{\lambda}, \tau_{\lambda})\)</span></p></li>
<li><p><span class="math inline">\(\Large \mu_{\lambda} \sim normal(0, 0.1)\)</span></p></li>
<li><p><span class="math inline">\(\Large \sigma_{\lambda} \sim gamma(0.25, 0.25) \bigg(note:\tau_{\lambda}=\frac{1}{\sigma^2_{\lambda}}\bigg)\)</span></p></li>
<li><p><span class="math inline">\(\Large \sigma_{Obs} \sim gamma(0.25, 0.25) \bigg(note:\tau_{Obs}=\frac{1}{\sigma^2_{Obs}}\bigg)\)</span></p></li>
</ul>
<p>Although it may not be obvious, there is one additional parameter in the model that requires a prior. Note that for years 2:T, <span class="math inline">\(N_t\)</span> is a deterministic function of the previous year’s abundance and <span class="math inline">\(\lambda_t\)</span>. However, <span class="math inline">\(N_1\)</span> has no predecessor. As a result, we need to treat it as a random variable and give it a prior:</p>
<ul>
<li><span class="math inline">\(\Large N_1 \sim uniform(0, 500)\)</span></li>
</ul>
<p>With the likelihoods and priors defined, we can now write the model file for JAGS:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>(<span class="st">"inst/jags/ssm.jags"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span>
<span class="st">model { </span>
<span class="st">    # Priors and constraints</span>
<span class="st">    N.est[1] ~ dunif(0, 500)  # Initial population size</span>

<span class="st">    for (t in 1:(nYears-1)){</span>
<span class="st">      lambda[t] ~ dnorm(mu.lambda, tau.lambda) </span>
<span class="st">    }</span>

<span class="st">    mu.lambda ~ dnorm(0, 0.1)          # Mean growth rate</span>
<span class="st">    sigma.lambda ~ dgamma(0.25, 0.25)  # SD of state process</span>
<span class="st">    tau.lambda &lt;- pow(sigma.lambda, -2)</span>
<span class="st">    </span>
<span class="st">    sigma.obs ~ dgamma(0.25, 0.25)     # SD of observation process</span>
<span class="st">    tau.obs &lt;- pow(sigma.obs, -2)</span>
<span class="st">  </span>
<span class="st">    # Likelihood</span>
<span class="st">    # State process</span>
<span class="st">    for (t in 1:(nYears-1)){</span>
<span class="st">      N.est[t+1] &lt;- N.est[t] * lambda[t] </span>
<span class="st">    }</span>
<span class="st">    # Observation process</span>
<span class="st">    for (t in 1:nYears) {</span>
<span class="st">      y[t] ~ dnorm(N.est[t], tau.obs)</span>
<span class="st">    }</span>
<span class="st">    }</span>
<span class="st">    "</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>()</code></pre></div>
<p>Be sure you go through this file and understand how each part of the code corresponds to the likelihoods and priors defined above.</p>
<div id="simulating-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-the-data" class="anchor"></a>Simulating the data</h3>
<p>Next we will simulate 25 years of abundances and counts from the model defined above. For the simulation, we will assume an initial abundance of 30 individuals, <span class="math inline">\(\mu_{\lambda} = 1.02\)</span>, <span class="math inline">\(\sigma_{\lambda} = 0.15\)</span>, and <span class="math inline">\(\sigma_{Obs} = 4.5\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nYears &lt;-<span class="st"> </span><span class="dv">25</span>      <span class="co"># Number of years</span>
N1 &lt;-<span class="st"> </span><span class="dv">30</span>           <span class="co"># Initial population size</span>
mu.lambda &lt;-<span class="st"> </span><span class="fl">1.02</span>  <span class="co"># Mean annual population growth rate</span>
sigma.lambda &lt;-<span class="st"> </span><span class="fl">0.15</span>   <span class="co"># Process (temporal) variation of the growth rate</span>
sigma.obs &lt;-<span class="st"> </span><span class="dv">20</span>        <span class="co"># SD of the observation error</span></code></pre></div>
<p>Next, we create an empty data frame to store the true abundances and the observed counts and we generate random values of <span class="math inline">\(\lambda_t\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Empty vectors to store the data
ssm_sim1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">Year =</span> <span class="dv">1</span><span class="op">:</span>nYears, 
                       <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nYears),
                       <span class="dt">N =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nYears))

## Fill in initial abundance
ssm_sim1<span class="op">$</span>N[<span class="dv">1</span>] &lt;-<span class="st"> </span>N1

## Randomly generate annual lambda values
lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(nYears<span class="op">-</span><span class="dv">1</span>, mu.lambda, sigma.lambda)</code></pre></div>
<p>Finally, we use loops to generate the true abundances and counts. Note that, once we have <span class="math inline">\(N_1\)</span> and <span class="math inline">\(\lambda_t\)</span>, the <span class="math inline">\(N_t\)</span> values are <strong>not stochastic</strong>. This should hopefully make it clear why we need a prior for <span class="math inline">\(N_1\)</span> but not <span class="math inline">\(N_2,...,N_T\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Loop over years 1:nYears - 1 to generate true abundance
<span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(nYears<span class="op">-</span><span class="dv">1</span>)){
   ssm_sim1<span class="op">$</span>N[t<span class="op">+</span><span class="dv">1</span>] &lt;-<span class="st"> </span>ssm_sim1<span class="op">$</span>N[t] <span class="op">*</span><span class="st"> </span>lambda[t]
}

## Loop over all years to generate counts
<span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nYears){
   ssm_sim1<span class="op">$</span>y[t] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(<span class="dv">1</span>, ssm_sim1<span class="op">$</span>N[t], sigma.obs)
}

<span class="kw">ggplot</span>(ssm_sim1, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey30"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Notice how much more variable the counts are compared to the true abundances. That additional variation is caused solely by observation error and if we ignored the distinction between process and observation error, we would greatly overestimate the process variance in our system.</p>
</div>
</div>
<div id="analysis-in-jags" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-in-jags" class="anchor"></a>Analysis in JAGS</h2>
<p>Now we’re ready to fit the model in JAGS. First bundle the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Bundle data
jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> ssm_sim1<span class="op">$</span>y, <span class="dt">nYears =</span> nYears)</code></pre></div>
<p>Next, set initial values. Remember that we need to set initial values for <span class="math inline">\(N_1\)</span> but not the remainder of the <span class="math inline">\(N\)</span>’s. So we will randomly generate an initial value for <code>N[1]</code> and then fill in <code>NA</code> for all other other elements in the <code>N</code> vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Initial values</span>
inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sigma.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">5</span>), 
                         <span class="dt">mu.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">2</span>), 
                         <span class="dt">sigma.obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>), 
                         <span class="dt">N.est =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">20</span>, <span class="dv">40</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, (nYears<span class="op">-</span><span class="dv">1</span>))))} </code></pre></div>
<p>Finally, set the parameters to monitor and the MCMC settings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Parameters monitored</span>
parameters &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lambda"</span>, <span class="st">"mu.lambda"</span>, <span class="st">"sigma.obs"</span>, <span class="st">"sigma.lambda"</span>, <span class="st">"N.est"</span>)

<span class="co"># MCMC settings</span>
ni &lt;-<span class="st"> </span><span class="dv">25000</span>
nt &lt;-<span class="st"> </span><span class="dv">3</span>
nb &lt;-<span class="st"> </span><span class="dv">10000</span>
nc &lt;-<span class="st"> </span><span class="dv">3</span>

<span class="co"># Call WinBUGS from R (BRT &lt;1 min)</span>
ssm &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(<span class="dt">data =</span> jags.data, <span class="dt">inits =</span> inits, <span class="dt">parameters.to.save =</span> parameters, 
                    <span class="dt">model.file =</span> <span class="st">"jags/ssm.jags"</span>, <span class="dt">n.chains =</span> nc, <span class="dt">n.thin =</span> nt, 
                    <span class="dt">n.iter =</span> ni, <span class="dt">n.burnin =</span> nb)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(ssm)</code></pre></div>
<p>Now add the estimated <span class="math inline">\(N\)</span> values (plus uncertainty) to the original data frame and visualize the results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssm_sim1 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(ssm_sim1, 
                          <span class="dt">Estimated =</span> ssm<span class="op">$</span>mean<span class="op">$</span>N.est, 
                          <span class="dt">LCI =</span> ssm<span class="op">$</span>q2.<span class="dv">5</span><span class="op">$</span>N.est, 
                          <span class="dt">UCI =</span> ssm<span class="op">$</span>q97.<span class="dv">5</span><span class="op">$</span>N.est)

<span class="kw">ggplot</span>(ssm_sim1, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> LCI, <span class="dt">ymax =</span> UCI), <span class="dt">fill =</span> <span class="st">"grey80"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimated), <span class="dt">color =</span> <span class="st">"grey50"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey20"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-9-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Notice how much smoother the estimates of <span class="math inline">\(N\)</span> (light grey line) are relative to the raw counts, a good indication that the model was able to seperate the observation error from the process variation.</p>
</div>
<div id="unbiased-indices-of-n" class="section level2">
<h2 class="hasAnchor">
<a href="#unbiased-indices-of-n" class="anchor"></a>Unbiased <em>indices</em> of <span class="math inline">\(N\)</span>
</h2>
<p>The state-space model described above assumes that, on average, false positive counts cancel out false negative counts. What happens when that’s not the case? Let’s now simulate data assuming:</p>
<p><span class="math display">\[\Large y_t \sim binomial(N_t, p)\]</span></p>
<p>where <span class="math inline">\(p\)</span> is the probability that an individual in the population is counted. In this case, <span class="math inline">\(y_t &lt; N_t\)</span>. We will simulate these data assuming <span class="math inline">\(N_t=50\)</span> in all years:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssm_sim2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">Year =</span> <span class="dv">1</span><span class="op">:</span>nYears, 
                       <span class="dt">N =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">50</span>, nYears),
                       <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nYears))

p &lt;-<span class="st"> </span><span class="fl">0.7</span>

<span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nYears){
  ssm_sim2<span class="op">$</span>y[t] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dv">1</span>, ssm_sim2<span class="op">$</span>N[t], p)
}

<span class="kw">ggplot</span>(ssm_sim2, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey30"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<p>In this case. <em>all</em> of the variation in the counts is observation error <span class="math inline">\(-\)</span> the true counts are constant.</p>
<p>Prepare the data for JAGS, create initial values, and then fit the model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Bundle data</span>
jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> ssm_sim2<span class="op">$</span>y, <span class="dt">nYears =</span> nYears)

<span class="co"># Initial values</span>
inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sigma.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">5</span>), 
                         <span class="dt">mu.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">2</span>), 
                         <span class="dt">sigma.obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>), 
                         <span class="dt">N.est =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">60</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, (nYears<span class="op">-</span><span class="dv">1</span>))))}

<span class="co"># Parameters monitored</span>
parameters &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lambda"</span>, <span class="st">"mu.lambda"</span>, <span class="st">"sigma.obs"</span>, <span class="st">"sigma.lambda"</span>, <span class="st">"N.est"</span>)

<span class="co"># MCMC settings</span>
ni &lt;-<span class="st"> </span><span class="dv">25000</span>
nt &lt;-<span class="st"> </span><span class="dv">3</span>
nb &lt;-<span class="st"> </span><span class="dv">10000</span>
nc &lt;-<span class="st"> </span><span class="dv">3</span>

<span class="co"># Call WinBUGS from R (BRT &lt;1 min)</span>
ssm2 &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(jags.data, inits, 
                     parameters, <span class="st">"jags/ssm.jags"</span>, 
                     <span class="dt">n.chains =</span> nc, <span class="dt">n.thin =</span> nt, <span class="dt">n.iter =</span> ni, 
                     <span class="dt">n.burnin =</span> nb)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(ssm2)</code></pre></div>
<p>Plot the results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssm_sim2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(ssm_sim2, <span class="dt">Estimated =</span> ssm2<span class="op">$</span>mean<span class="op">$</span>N.est, 
                          <span class="dt">LCI =</span> ssm2<span class="op">$</span>q2.<span class="dv">5</span><span class="op">$</span>N.est, 
                          <span class="dt">UCI =</span> ssm2<span class="op">$</span>q97.<span class="dv">5</span><span class="op">$</span>N.est)

<span class="kw">ggplot</span>(ssm_sim2, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> LCI, <span class="dt">ymax =</span> UCI), <span class="dt">fill =</span> <span class="st">"grey80"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimated), <span class="dt">color =</span> <span class="st">"grey50"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey20"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Notice that <span class="math inline">\(N \times p = 50 \times 0.7 = 35\)</span>, which is about the average of the model estimates. Thus, in this case, the model does not provide unbiased estimates of <span class="math inline">\(N\)</span> but it does provide unbiased estimates of <span class="math inline">\(Np\)</span>. Although the model still estimates some process variance (it thinks <span class="math inline">\(\sigma_{\lambda}&gt;0\)</span>), we would correctly conclude from this analysis that the population is stable, so an index in this case isn’t completely useless.</p>
</div>
<div id="systematic-bias-in-the-state-space-model" class="section level2">
<h2 class="hasAnchor">
<a href="#systematic-bias-in-the-state-space-model" class="anchor"></a>Systematic bias in the state-space model</h2>
<p>Finally, let’s revise the above observation model assuming that there is a trend in detection probability. Perhaps due to the observed stability of the population, observers now spend less time looking for individuals they did at the beginning of the study. Thus:</p>
<p><span class="math display">\[\Large y_t \sim binomial(N_t, p_t)\]</span></p>
<p><span class="math display">\[\Large logit(p_{t}) = \alpha + \beta \times year_t\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are the intercept and slope coefficients that describe annual variation in <span class="math inline">\(p\)</span>. Again, we’ll assume that <span class="math inline">\(y_t &lt; N_t\)</span> and <span class="math inline">\(N_t=50\)</span> in all years:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssm_sim3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">Year =</span> <span class="dv">1</span><span class="op">:</span>nYears, 
                       <span class="dt">N =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">50</span>, nYears),
                       <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nYears))

<span class="co"># Decreasing trend of logit(p)</span>
lp &lt;-<span class="st"> </span><span class="fl">0.5</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.1</span><span class="op">*</span>(<span class="dv">1</span><span class="op">:</span>nYears)  

<span class="co"># Transform lp to probability scale</span>
p &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Logistic">plogis</a></span>(lp)

<span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nYears){
  ssm_sim3<span class="op">$</span>y[t] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(<span class="dv">1</span>, ssm_sim3<span class="op">$</span>N[t], p[t])
}

<span class="kw">ggplot</span>(ssm_sim3, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey30"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-14-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Prepare the data for JAGS, create initial values, and then fit the model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Bundle data</span>
jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> ssm_sim3<span class="op">$</span>y, <span class="dt">nYears =</span> nYears)

<span class="co"># Initial values</span>
inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sigma.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">5</span>), 
                         <span class="dt">mu.lambda =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">2</span>), 
                         <span class="dt">sigma.obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>), 
                         <span class="dt">N.est =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">60</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, (nYears<span class="op">-</span><span class="dv">1</span>))))}

<span class="co"># Parameters monitored</span>
parameters &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lambda"</span>, <span class="st">"mu.lambda"</span>, <span class="st">"sigma.obs"</span>, <span class="st">"sigma.lambda"</span>, <span class="st">"N.est"</span>)

<span class="co"># MCMC settings</span>
ni &lt;-<span class="st"> </span><span class="dv">25000</span>
nt &lt;-<span class="st"> </span><span class="dv">3</span>
nb &lt;-<span class="st"> </span><span class="dv">10000</span>
nc &lt;-<span class="st"> </span><span class="dv">3</span>

<span class="co"># Call WinBUGS from R (BRT &lt;1 min)</span>
ssm3 &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(jags.data, inits, 
                     parameters, <span class="st">"jags/ssm.jags"</span>, 
                     <span class="dt">n.chains =</span> nc, <span class="dt">n.thin =</span> nt, <span class="dt">n.iter =</span> ni, 
                     <span class="dt">n.burnin =</span> nb)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(ssm3)</code></pre></div>
<p>Plot the results:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ssm_sim3 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(ssm_sim3, <span class="dt">Estimated =</span> ssm3<span class="op">$</span>mean<span class="op">$</span>N.est, 
                          <span class="dt">LCI =</span> ssm3<span class="op">$</span>q2.<span class="dv">5</span><span class="op">$</span>N.est, 
                          <span class="dt">UCI =</span> ssm3<span class="op">$</span>q97.<span class="dv">5</span><span class="op">$</span>N.est)

<span class="kw">ggplot</span>(ssm_sim3, <span class="kw">aes</span>(<span class="dt">x =</span> Year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> LCI, <span class="dt">ymax =</span> UCI), <span class="dt">fill =</span> <span class="st">"grey80"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> Estimated), <span class="dt">color =</span> <span class="st">"grey50"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N), <span class="dt">color =</span> <span class="st">"grey20"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;"></p>
<p>As you can see, in this case the model thinks that abundance is decreasing when in fact it is <span class="math inline">\(p\)</span> that is changing. This example shows one of the weaknesses of state-space models <span class="math inline">\(-\)</span> without additional information, the model cannot fully distinguish between changes in the process model vs. changes in the observation process (we saw this above when the model assumed some of the noise in the counts was assumed to be process variation even though <span class="math inline">\(\sigma_{\lambda}=0\)</span>). Nonetheless, state-space models provide an intuitive way to model time series data that is subject to observation error when the assumptions of the model are met.</p>
</div>
<div id="estimating-population-dynamics-of-the-gunnison-island-pelican-colony" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-population-dynamics-of-the-gunnison-island-pelican-colony" class="anchor"></a>Estimating population dynamics of the Gunnison Island pelican colony</h2>
<p>Next, we will use a slightly different state-space model to analyze growth of a nesting colony of American white pelicans (<em>Pelecanus erythrorhynchos</em>) on Gunnison Island in the Great Salt Lake. White pelicans are one of the largest birds in North America and Gunnison Island hosts one of the largest inland colonies in the Pacific flyway. Gunnison Island is a remote spit of land in the northwest part of the lake. Despite being surrounded by hyper-saline water, the island is a good place for nesting pelicans because it provides a haven from predators. The size of this colony is of regional importance both ecologically (as a source for smaller colonies) and due to collision risk with airplanes at the Salt Lake airport.</p>
<div class="figure" style="text-align: center">
<img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/American_White_Pelican_%28Las_Gallinas_Wildlife_Ponds%29.jpg" alt="American White Pelican. Image courtesy of Frank Schulenburg via WikiCommons" width="80%"><p class="caption">
American White Pelican. Image courtesy of Frank Schulenburg via WikiCommons
</p>
</div>
<p>Colony counts have been conducted almost annual since the early 1960’s, with brief gaps in the late ’60s and again in the late ’70s. These counts indicate that the colony grew considerably in the ’70s and ’80s but has since leveled off near its carrying capacity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"pelicans"</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(pelicans)

<span class="kw">ggplot</span>(pelicans, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> count)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">year</th>
<th align="right">count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1963</td>
<td align="right">4500</td>
</tr>
<tr class="even">
<td align="right">1964</td>
<td align="right">3000</td>
</tr>
<tr class="odd">
<td align="right">1965</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1966</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">1967</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1968</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p><img src="state_space_files/figure-html/unnamed-chunk-20-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Our goal is to estimate the average rate of population growth from these data. To do so, we will slightly modify the model used above by recognizing that:</p>
<p><span class="math display">\[\Large log(\lambda_t) = r_t\]</span></p>
<p>and therefore:</p>
<p><span class="math display">\[\Large log(N_{t+1}) = log(N_t) + r_t\]</span></p>
<p>Working on the log scale often helps with parameter estimation and as we will see in the next lab, this formulation makes it easy to expand this model to include density dependence. Aside from this change, the pelican model is very similar to the model we analyzed above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>(<span class="st">"jags/AWPE_ssm.jags"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="st">"</span>
<span class="st">    model{</span>
<span class="st">    # Priors</span>
<span class="st">    logN.est[1] ~ dnorm(0, 0.01)      # Log initial population size</span>

<span class="st">    for (t in 1:(nYears - 1)){</span>
<span class="st">      r[t] ~ dnorm(mean.r, tau.r)</span>
<span class="st">    }</span>
<span class="st">    mean.r ~ dnorm(1, 0.001)          # Mean growth rate</span>

<span class="st">    sigma.r ~ dunif(0, 10)            # SD of state processes</span>
<span class="st">    tau.r &lt;- pow(sigma.r, -2)</span>

<span class="st">    sigma.obs ~ dunif(0, 10)          # SD of observation processes</span>
<span class="st">    tau.obs &lt;- pow(sigma.obs, -2)</span>

<span class="st">    # Likelihood</span>
<span class="st">    # State process</span>
<span class="st">    for (t in 1:(nYears-1)){</span>
<span class="st">      logN.est[t+1] &lt;- logN.est[t] + r[t]</span>
<span class="st">    }</span>

<span class="st">    # Observation process</span>
<span class="st">    for (t in 1:nYears){</span>
<span class="st">      y[t] ~ dnorm(logN.est[t], tau.obs)</span>
<span class="st">    }</span>

<span class="st">    # Population sizes on real scale</span>
<span class="st">    for (t in 1:nYears){</span>
<span class="st">     N.est[t] &lt;- exp(logN.est[t])</span>
<span class="st">    }</span>
<span class="st">    }</span>
<span class="st">    "</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sink">sink</a></span>()</code></pre></div>
<p>Again, be sure you understand how this model code translates into the model description above.</p>
<p>Next, we’ll bundle the data. Remember that because we are modeling <span class="math inline">\(log(N_t)\)</span>, we need to enter our counts as <span class="math inline">\(log(y_t)\)</span>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Bundle data
jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(pelicans<span class="op">$</span>count), <span class="dt">nYears =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(pelicans))</code></pre></div>
<p>Note that JAGS can not only handle the <code>NA</code> counts, it will still estimate <span class="math inline">\(N_t\)</span> in those years. This is a major benefit of modeling parameters as random variables <span class="math inline">\(-\)</span> by providing a process model and a probability distribution for each <span class="math inline">\(N_t\)</span>, the model will estimate a posterior distribution for each annual abundance even if we don’t provide any data!</p>
<p>Next, create the initial values function and set the MCMC settings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sigma.r =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),
                         <span class="dt">mean.r =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>),
                         <span class="dt">sigma.obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),
                         <span class="dt">logN.est =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(pelicans)<span class="op">-</span><span class="dv">1</span>))))}

params &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mean.r"</span>, <span class="st">"sigma.obs"</span>, <span class="st">"sigma.r"</span>, <span class="st">"N.est"</span>, <span class="st">"r"</span>)

ni &lt;-<span class="st"> </span><span class="dv">30000</span>
nt &lt;-<span class="st"> </span><span class="dv">1</span>
nb &lt;-<span class="st"> </span><span class="dv">5000</span>
nc &lt;-<span class="st"> </span><span class="dv">3</span></code></pre></div>
<p>Finally, fit the model. Note that we will now set <code>parallel = TRUE</code> in the <code>jags</code> function to speed up model fitting. Unfortunately, this means we won’t get a progress bar:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">awpe_ssm &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(<span class="dt">data =</span> jags.data,
                 <span class="dt">model.file =</span> <span class="st">"jags/AWPE_ssm.jags"</span>,
                 <span class="dt">parameters.to.save =</span> params,
                 <span class="dt">inits =</span> inits,
                 <span class="dt">n.chains =</span> nc,
                 <span class="dt">n.iter =</span> ni,
                 <span class="dt">n.thin =</span> nt,
                 <span class="dt">n.burnin =</span> nb, <span class="dt">parallel =</span> <span class="ot">TRUE</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(awpe_ssm)</code></pre></div>
<p>Now plot the estimated abundance vs. the counts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pelicans &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(pelicans, 
                          <span class="dt">N.est =</span> awpe_ssm<span class="op">$</span>mean<span class="op">$</span>N.est, 
                          <span class="dt">LCI =</span> awpe_ssm<span class="op">$</span>q2.<span class="dv">5</span><span class="op">$</span>N.est, 
                          <span class="dt">UCI =</span> awpe_ssm<span class="op">$</span>q97.<span class="dv">5</span><span class="op">$</span>N.est)

<span class="kw">ggplot</span>(pelicans, <span class="kw">aes</span>(<span class="dt">x =</span> year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> LCI, <span class="dt">ymax =</span> UCI)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N.est), <span class="dt">color =</span> <span class="st">"white"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N.est), <span class="dt">color =</span> <span class="st">"white"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> count), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-26-1.png" width="576" style="display: block; margin: auto;"></p>
<p>As for the simulated data, notice how the estimated abundances are “smoothed” relative to the observed counts.</p>
<p>Also note that the model returns estimates of <span class="math inline">\(N_t\)</span> even in the years with no counts. This is a powerful advantage of Bayesian methods. For example, what if we want to project counts into the future? All we have to do is add <code>NA</code> counts to the data frame and adjust the number of years and we get these predictions (and associated uncertainty) for free:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Bundle data with additional years
jags.data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(pelicans<span class="op">$</span>count), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, <span class="dv">20</span>)), 
                  <span class="dt">nYears =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(pelicans) <span class="op">+</span><span class="st"> </span><span class="dv">20</span>)

inits &lt;-<span class="st"> </span><span class="cf">function</span>(){<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sigma.r =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),
                         <span class="dt">mean.r =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>),
                         <span class="dt">sigma.obs =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),
                         <span class="dt">logN.est =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">10</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(pelicans)<span class="op">-</span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">20</span>))))}

awpe_ssm2 &lt;-<span class="st"> </span>jagsUI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/jagsUI/topics/jags">jags</a></span>(<span class="dt">data =</span> jags.data,
                 <span class="dt">model.file =</span> <span class="st">"jags/AWPE_ssm.jags"</span>,
                 <span class="dt">parameters.to.save =</span> params,
                 <span class="dt">inits =</span> inits,
                 <span class="dt">n.chains =</span> nc,
                 <span class="dt">n.iter =</span> ni,
                 <span class="dt">n.thin =</span> nt,
                 <span class="dt">n.burnin =</span> nb, <span class="dt">parallel =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pelicans2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(pelicans<span class="op">$</span>year, 
                                 <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dt">from =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(pelicans<span class="op">$</span>year) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, 
                                     <span class="dt">to =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(pelicans<span class="op">$</span>year) <span class="op">+</span><span class="st"> </span><span class="dv">20</span>)),
                        <span class="dt">count =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(pelicans<span class="op">$</span>count, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, <span class="dv">20</span>)),
                        <span class="dt">N.est =</span> awpe_ssm2<span class="op">$</span>mean<span class="op">$</span>N.est, 
                        <span class="dt">LCI =</span> awpe_ssm2<span class="op">$</span>q2.<span class="dv">5</span><span class="op">$</span>N.est, 
                        <span class="dt">UCI =</span> awpe_ssm2<span class="op">$</span>q97.<span class="dv">5</span><span class="op">$</span>N.est)

<span class="kw">ggplot</span>(pelicans2, <span class="kw">aes</span>(<span class="dt">x =</span> year)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> LCI, <span class="dt">ymax =</span> UCI)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N.est), <span class="dt">color =</span> <span class="st">"white"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> N.est), <span class="dt">color =</span> <span class="st">"white"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> count), <span class="dt">color =</span> <span class="st">"red"</span>)</code></pre></div>
<p><img src="state_space_files/figure-html/unnamed-chunk-29-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="expanding-the-state-space-model" class="section level2">
<h2 class="hasAnchor">
<a href="#expanding-the-state-space-model" class="anchor"></a>Expanding the state-space model</h2>
<p>The simple process model used throughout this lab is a good starting point for modeling population dynamics. However, this model is quite limiting. For example, it appears the growth of the pelican colony did not show random variation around a mean for the entire study period. Rather, it experienced several decades of rapid growth followed by fluctuations around an apparent carrying capacity. Likewise, the model above ignores vital rates (survival and reproduction) or age structure. In the next lab, we will explore how use the flexibility of this approach to develop more complex (and realistic) models of population growth.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#fitting-state-space-models-to-simulated-data">Fitting state-space models to simulated data</a></li>
      <li><a href="#analysis-in-jags">Analysis in JAGS</a></li>
      <li><a href="#unbiased-indices-of-n">Unbiased <em>indices</em> of <span class="math inline">\(N\)</span></a></li>
      <li><a href="#systematic-bias-in-the-state-space-model">Systematic bias in the state-space model</a></li>
      <li><a href="#estimating-population-dynamics-of-the-gunnison-island-pelican-colony">Estimating population dynamics of the Gunnison Island pelican colony</a></li>
      <li><a href="#expanding-the-state-space-model">Expanding the state-space model</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
