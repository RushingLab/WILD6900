<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quantifying temporary emigration using multi-state models • WILD6900</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Quantifying temporary emigration using multi-state models">
<meta property="og:description" content="WILD6900">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WILD6900</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/syllabus.html">
    <span class="fas fa-book"></span>
     
    Syllabus
  </a>
</li>
<li>
  <a href="../articles/schedule.html">
    <span class="fas fa-calendar"></span>
     
    Schedule
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-pdf-o"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Lecture0/Lecture0.html">Lecture 0: Introduction to WILD6900</a>
    </li>
    <li>
      <a href="../articles/Lecture1/Lecture1.html">Lecture 1: Introduction to statistical inference in ecology</a>
    </li>
    <li>
      <a href="../articles/Lecture2/Lecture2.html">Lecture 2: Probability refresher (or introduction)</a>
    </li>
    <li>
      <a href="../articles/Lecture3/Lecture3.html">Lecture 3: Principles of Bayesian inference</a>
    </li>
    <li>
      <a href="../articles/Lecture4/Lecture4.html">Lecture 4: More about prior distributions</a>
    </li>
    <li>
      <a href="../articles/Lecture5/Lecture5.html">Lecture 5: Implementing Bayesian models: Introduction to MCMC samplers</a>
    </li>
    <li>
      <a href="../articles/Lecture6/Lecture6.html">Lecture 6: Introduction of Bayesian analysis using JAGS</a>
    </li>
    <li>
      <a href="../articles/Lecture7/Lecture7.html">Lecture 7: Generalized linear model review</a>
    </li>
    <li>
      <a href="../articles/Lecture8/Lecture8.html">Lecture 8: Introduction to hierarchical models</a>
    </li>
    <li>
      <a href="../articles/Lecture9/Lecture9.html">Lecture 9: Introduction to state-space models</a>
    </li>
    <li>
      <a href="../articles/Lecture10/Lecture10.html">Lecture 10: Estimating abundance: N-mixture models</a>
    </li>
    <li>
      <a href="../articles/Lecture11/Lecture11.html">Lecture 11: Estimating abundance: Occupancy modeling</a>
    </li>
    <li>
      <a href="../articles/Lecture12/Lecture12.html">Lecture 12: Estimating abundance: Closed-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture13/Lecture13.html">Lecture 13: Estimating survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture14/Lecture14.html">Lecture 14: Estimating abundance and survival: Open-population capture-mark-recapture</a>
    </li>
    <li>
      <a href="../articles/Lecture15/Lecture15.html">Lecture 15: Multi-state models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-desktop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/projects_and_directories.html">Projects and directories</a>
    </li>
    <li>
      <a href="../articles/rmarkdown_intro.html">Introduction to R Markdown</a>
    </li>
    <li>
      <a href="../articles/priors.html">Creating prior distributions</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Simulating regression data</a>
    </li>
    <li>
      <a href="../articles/metropolis.html">Metropolis sampler for linear regression model</a>
    </li>
    <li>
      <a href="../articles/poisson_glm.html">Poisson and binomial GLMs in JAGS</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Random effects ANCOVA in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space.html">Simple state-space models in JAGS</a>
    </li>
    <li>
      <a href="../articles/state_space2.html">Age-structured state-space models</a>
    </li>
    <li>
      <a href="../articles/n-mixture1.html">Introduction to N-mixture models</a>
    </li>
    <li>
      <a href="../articles/n-mixture2.html">Advanced N-mixture models: Zero-inflation and posterior predictive checks</a>
    </li>
    <li>
      <a href="../articles/multi_spp_occ.html">Estimating species richness using hierarchical occupancy models</a>
    </li>
    <li>
      <a href="../articles/cjs.html">Cormack-Jolly-Seber models</a>
    </li>
    <li>
      <a href="../articles/multi-state.html">Quantifying temporary emigration using multi-state models</a>
    </li>
    <li>
      <a href="../articles/multi-state2.html">Multi-state model for survival/transition probability of a perennial plant</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/homework.html">
    <span class="fas fa-pencil-square-o"></span>
     
    Assignments
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="multi-state_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="multi-state_files/kePrint-0.0.1/kePrint.js"></script><link href="multi-state_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Quantifying temporary emigration using multi-state models</h1>
                        <h4 class="author">WILD6900</h4>
            
            <h4 class="date">2021-01-05</h4>
      
      
      <div class="hidden name"><code>multi-state.Rmd</code></div>

    </div>

    
    
<p>As we discussed in the <a href="https://rushinglab.github.io/WILD6900/articles/Lecture14/Lecture14.html#1">open-population capture-recapture lecture lecture</a>, the CJS model assumes that all emigration is permanent. This assumption is necessary because if we get, for example, a capture history of <code>101</code>, we assume that the individual was present and <em>available to be detected</em> on the second occasion. We simply failed to detect it and that occurred with probability <span class="math inline">\(1-p_2\)</span>. But what if the individual was not available to be detected? Maybe it’s breeding territory spanned the study area boundary and it was simply off the plot on the second occasion. Maybe we’re studying plants and an individual was dormant for the second year of the study. Or maybe we only sample during the breeding season and this individual skipped breeding in the second year. In all cases, the individual was <em>temporarily</em> unavailable for detection. In other words, on the second occasion <span class="math inline">\(p_2 = 0\)</span> for this individual.</p>
<p>If this temporary emigration is random, estimates of <span class="math inline">\(p\)</span> will be too low (because all the instances where <span class="math inline">\(p=0\)</span> will be incorrectly used to estimate <span class="math inline">\(p\)</span>) but estimates of <span class="math inline">\(\phi\)</span> will be unbiased. However, if the temporary emigration process is <em>Markovian</em> <span class="math inline">\(-\)</span> that is, whether an individual is unavailable for detection depends on whether the individual was available/unavailable in the previous time step <span class="math inline">\(-\)</span> estimates of survival can be biased.</p>
<p>Kory &amp; Schaub (2015) provide a nice example of using multi-state capture-recapture models to estimate (and correct for) temporary emigration that is caused by individuals leaving and re-entering the study site. In this model, individuals can be in one of three states: “alive and present”, “alive and absent”, and “dead”. We can define the probabilities associated with each state using three parameters:</p>
<ul>
<li><p><span class="math inline">\(\phi\)</span>: survival probability</p></li>
<li><p><span class="math inline">\(\psi_{IO}\)</span>: probability of moving from <strong>I</strong>n to <strong>O</strong>ut (i.e., from present to absent)</p></li>
<li><p><span class="math inline">\(\psi_{OI}\)</span>: probability of moving from <strong>O</strong>ut to <strong>I</strong>n (i.e., from absent to present)</p></li>
</ul>
<p>Based on these three parameters, we can create that state transition matrix:</p>
<table class="table table table-striped table-hover table-condensed table-responsive">
<thead><tr>
<th style="text-align:center;">
</th>
<th style="text-align:center;">
Present
</th>
<th style="text-align:center;">
Absent
</th>
<th style="text-align:center;">
Dead
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:center;">
Present
</td>
<td style="text-align:center;">
<span class="math inline">\(\phi (1 - \psi_{IO})\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(\phi \psi_{IO}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 - \phi\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Absent
</td>
<td style="text-align:center;">
<span class="math inline">\(\phi \psi_{OI}\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(\phi (1 - \psi_{OI})\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 - \phi\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Dead
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
</tbody>
</table>
<p>Although individuals can be in three states, there are only two observations <span class="math inline">\(-\)</span> “seen” and “not seen” <span class="math inline">\(-\)</span> and therefore a single detection parameter <span class="math inline">\(p\)</span>. Note that <span class="math inline">\(p\)</span> is interpreted as the probability that an individual is captured <em>given that it is both <strong>alive</strong> and <strong>present</strong> on a given capture occasion</em>. As a result, we never detect individuals that are “alive and absent” or individuals that are dead:</p>
<table class="table table table-striped table-hover table-condensed table-responsive">
<thead><tr>
<th style="text-align:center;">
</th>
<th style="text-align:center;">
Seen
</th>
<th style="text-align:center;">
Not Seen
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:center;">
Present
</td>
<td style="text-align:center;">
<span class="math inline">\(p\)</span>
</td>
<td style="text-align:center;">
<span class="math inline">\(1 - p\)</span>
</td>
</tr>
<tr>
<td style="text-align:center;">
Absent
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
<tr>
<td style="text-align:center;">
Dead
</td>
<td style="text-align:center;">
0
</td>
<td style="text-align:center;">
1
</td>
</tr>
</tbody>
</table>
<div id="simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulated-data" class="anchor"></a>Simulated data</h2>
<p>Following Kéry &amp; Schaub (2015), we will simulate data as if it came from a capture-recapture study of hibernating salamanders. Individuals are captured and photographed in a single cave where the species hibernates over winter. This cave is not, however, the only hibernation site so when we go out to sample, individuals may be hibernating in a different cave. We will assume the following parameters:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define mean survival, transitions, recapture, as well as number of occasions, states, observations and released individuals</span>
<span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">0.85</span>
<span class="va">psiIO</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>
<span class="va">psiOI</span> <span class="op">&lt;-</span> <span class="fl">0.3</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.7</span>

<span class="co"># Sampling parameters</span>
<span class="va">n.occasions</span> <span class="op">&lt;-</span> <span class="fl">8</span>   <span class="co"># Number of capture occasions</span>
<span class="va">n.states</span> <span class="op">&lt;-</span> <span class="fl">3</span>      <span class="co"># Number of true states</span>
<span class="va">n.obs</span> <span class="op">&lt;-</span> <span class="fl">2</span>         <span class="co"># Number of observed states</span></code></pre></div>
<p>Next, create matrices to store the transition and observation probabilities:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 1. State process matrix</span>
<span class="va">PSI.STATE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">phi</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">psiIO</span><span class="op">)</span>, <span class="va">phi</span><span class="op">*</span><span class="va">psiIO</span>,     <span class="fl">1</span><span class="op">-</span><span class="va">phi</span>,
                      <span class="va">phi</span><span class="op">*</span><span class="va">psiOI</span>,     <span class="va">phi</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">psiOI</span><span class="op">)</span>, <span class="fl">1</span><span class="op">-</span><span class="va">phi</span>,
                      <span class="fl">0</span>,             <span class="fl">0</span>,             <span class="fl">1</span><span class="op">)</span>, 
                    nrow <span class="op">=</span> <span class="va">n.states</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># 2.Observation process matrix</span>
<span class="va">PSI.OBS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1</span><span class="op">-</span><span class="va">p</span>,
                    <span class="fl">0</span>, <span class="fl">1</span>,
                    <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, 
      nrow <span class="op">=</span> <span class="va">n.states</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </code></pre></div>
<p>To simulate the multi-state data, we’ll use a custom function from the Kéry &amp; Schaub (2015) book. This is a fairly complex function so we won’t go through it in detail (though you are encouraged to walk through it on your own. Understanding how the data is simulated will no doubt help you understand the model better). Note that we simulate the <code>state</code> and <code>event</code> using <code>rmultinom</code>. This function takes three arguments: <code>n</code>, <code>size</code> and <code>prob</code>. In this case, we simulate one value (<code>n=1</code>) with a single trial (<code>size = 1</code>; this is equivalent to using a categorical distribution). For <code>prob</code>, we provide a vector with the probability of transitioning to each state, in this case using the rows in the state and observation matrices:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define function to simulate multistate capture-recapture data</span>
<span class="va">simul.ms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">PSI.STATE</span>, <span class="va">PSI.OBS</span>, <span class="va">marked</span>, <span class="va">n.occasions</span>, <span class="va">unobservable</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">{</span>
   <span class="va">CH</span> <span class="op">&lt;-</span> <span class="va">CH.TRUE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, ncol <span class="op">=</span> <span class="va">n.occasions</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">marked</span><span class="op">)</span><span class="op">)</span>
   <span class="co"># Define a vector with the occasion of marking</span>
   <span class="va">mark.occ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">PSI.STATE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">marked</span><span class="op">)</span><span class="op">)</span>
   <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">marked</span><span class="op">)</span>
   <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">PSI.STATE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">g</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="kw">next</span>  <span class="co"># To avoid error message if nothing to replace</span>
      <span class="va">mark.occ</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">g</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">-</span><span class="va">g</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">g</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,<span class="va">s</span><span class="op">]</span> <span class="op">&lt;-</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n.occasions</span>, <span class="va">marked</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n.occasions</span>,<span class="va">s</span><span class="op">]</span><span class="op">)</span>
      <span class="op">}</span> <span class="co">#s</span>
   <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">marked</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">PSI.STATE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
         <span class="kw">if</span> <span class="op">(</span><span class="va">mark.occ</span><span class="op">[</span><span class="va">i</span>,<span class="va">s</span><span class="op">]</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="kw">next</span>
         <span class="va">first</span> <span class="op">&lt;-</span> <span class="va">mark.occ</span><span class="op">[</span><span class="va">i</span>,<span class="va">s</span><span class="op">]</span>
         <span class="va">CH</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">s</span>
         <span class="va">CH.TRUE</span><span class="op">[</span><span class="va">i</span>,<span class="va">first</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">s</span>
         <span class="op">}</span> <span class="co">#s</span>
      <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="op">(</span><span class="va">first</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="va">n.occasions</span><span class="op">)</span><span class="op">{</span>
         <span class="co"># Multinomial trials for state transitions</span>
         <span class="kw">if</span> <span class="op">(</span><span class="va">first</span><span class="op">==</span><span class="va">n.occasions</span><span class="op">)</span> <span class="kw">next</span>
         <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html">rmultinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">PSI.STATE</span><span class="op">[</span><span class="va">CH.TRUE</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>
         <span class="va">CH.TRUE</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">state</span>
         <span class="co"># Multinomial trials for observation process</span>
         <span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html">rmultinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">PSI.OBS</span><span class="op">[</span><span class="va">CH.TRUE</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>
         <span class="va">CH</span><span class="op">[</span><span class="va">i</span>,<span class="va">t</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">event</span>
         <span class="op">}</span> <span class="co">#t</span>
      <span class="op">}</span> <span class="co">#i</span>
   <span class="co"># Replace the NA and the highest state number (dead) in the file by 0</span>
   <span class="va">CH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">CH</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
   <span class="va">CH</span><span class="op">[</span><span class="va">CH</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">PSI.STATE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
   <span class="va">CH</span><span class="op">[</span><span class="va">CH</span><span class="op">==</span><span class="va">unobservable</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
   <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
   <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">CH</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
      <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">CH</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">z</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">CH</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id</span>,<span class="va">i</span><span class="op">)</span>, <span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
      <span class="op">}</span>
   <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>CH<span class="op">=</span><span class="va">CH</span><span class="op">[</span><span class="op">-</span><span class="va">id</span>,<span class="op">]</span>, CH.TRUE<span class="op">=</span><span class="va">CH.TRUE</span><span class="op">[</span><span class="op">-</span><span class="va">id</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>
   <span class="co"># CH: capture histories to be used</span>
   <span class="co"># CH.TRUE: capture histories with perfect observation</span>
<span class="op">}</span></code></pre></div>
<p>Now we’re ready to simulate the data. We first create a matrix with 70 individuals captured on each occasion (these individuals are by definition in state 1 “alive and present” on their first capture occasion). The data simulation function will then create capture histories for each individual. After simulating the capture histories, we create a vector with the first capture occasion for each individual and then recode the observed data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">marked</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, ncol <span class="op">=</span> <span class="va">n.states</span>, nrow <span class="op">=</span> <span class="va">n.occasions</span><span class="op">)</span>
<span class="va">marked</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">70</span>, <span class="va">n.occasions</span><span class="op">)</span> <span class="co"># Present</span>
<span class="va">marked</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n.occasions</span><span class="op">)</span>  <span class="co"># Absent</span>
<span class="va">marked</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n.occasions</span><span class="op">)</span>  <span class="co"># Dead </span>

<span class="co"># Execute simulation function</span>
<span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">simul.ms</span><span class="op">(</span><span class="va">PSI.STATE</span>, <span class="va">PSI.OBS</span>, <span class="va">marked</span>, <span class="va">n.occasions</span><span class="op">)</span>
<span class="va">CH</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">CH</span>

<span class="co"># Compute vector with occasion of first capture</span>
<span class="va">get.first</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">CH</span>, <span class="fl">1</span>, <span class="va">get.first</span><span class="op">)</span>

<span class="co"># Currently, "not seen" is coded as 0 but that is not allowed (we can't index a matrix by row 0!)</span>
<span class="co"># So here we recode the values so that:</span>
<span class="co"># 1 = seen alive, 2 = not seen</span>
<span class="va">rCH</span> <span class="op">&lt;-</span> <span class="va">CH</span>  <span class="co"># Recoded CH</span>
<span class="va">rCH</span><span class="op">[</span><span class="va">rCH</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span></code></pre></div>
<p>Multi-state models can be very computationally expensive. One way to speed them up is the provide the latent matrix <code>z</code> as partially-observed data. When the individual is seen, we know <span class="math inline">\(z\)</span>. When the individual is not seen, we don’t know the state so we code that as <code>z = NA</code>. The following function will take the observed capture history and create a matrix <code>z</code> with the partially-known states:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">known.state.ms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ms</span>, <span class="va">notseen</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># notseen: label for not seen</span>
  <span class="va">state</span> <span class="op">&lt;-</span> <span class="va">ms</span>
  <span class="va">state</span><span class="op">[</span><span class="va">state</span><span class="op">==</span><span class="va">notseen</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">state</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">state</span><span class="op">[</span><span class="va">i</span>,<span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can also define a function to create initial values for <code>z</code> and thereby avoid the dreaded <code>Invalid parent node</code> error:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Function to create initial values for unknown z</span>
<span class="va">ms.init.z</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ch</span>, <span class="va">f</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">{</span><span class="va">ch</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">:</span><span class="va">f</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span><span class="op">}</span>
  <span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ch</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">known.states</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">states</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">ch</span><span class="op">==</span><span class="va">states</span><span class="op">)</span>
  <span class="va">ch</span><span class="op">[</span><span class="op">-</span><span class="va">v</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">ch</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">known.states</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#the-model" class="anchor"></a>The model</h2>
<p>Here’s the JAGS code to fit this model. Work through the code so you know what it’s doing:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="st">"jags/tempem.jags"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">[1348 chars quoted with '"']</span>,fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sink.html">sink</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="running-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-model" class="anchor"></a>Running the model</h3>
<p>Now bundle the data and set the MCMC settings. Currently, <code>ni</code> and <code>nb</code> are set very low. This model takes a long time to run so these settings will allow us to work out any bugs without having to wait a long time to see the error message. Once you have the model running, increase these values to, say, 50,000 and 10,000:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Bundle data</span>
<span class="va">jags.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">rCH</span>, f <span class="op">=</span> <span class="va">f</span>, n.occasions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">rCH</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, nind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">rCH</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, z <span class="op">=</span> <span class="fu">known.state.ms</span><span class="op">(</span><span class="va">rCH</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Initial values</span>
<span class="va">inits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean.phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, mean.psiIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, mean.psiOI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, mean.p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, z <span class="op">=</span> <span class="fu">ms.init.z</span><span class="op">(</span><span class="va">rCH</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>  

<span class="co"># Parameters monitored</span>
<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean.phi"</span>, <span class="st">"mean.psiIO"</span>, <span class="st">"mean.psiOI"</span>, <span class="st">"mean.p"</span><span class="op">)</span>

<span class="co"># MCMC settings (change these once you know the model is running)</span>
<span class="va">ni</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="va">nt</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">nb</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">nc</span> <span class="op">&lt;-</span> <span class="fl">3</span></code></pre></div>
<p>Finally, fit the model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Call JAGS from R</span>
<span class="va">tempemi</span> <span class="op">&lt;-</span> <span class="fu">jagsUI</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jagsUI/man/jags.html">jags</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">jags.data</span>, inits <span class="op">=</span> <span class="va">inits</span>, parameters.to.save <span class="op">=</span> <span class="va">parameters</span>, 
                        model.file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"jags/tempem.jags"</span><span class="op">)</span>, 
                        n.chains <span class="op">=</span> <span class="va">nc</span>, n.thin <span class="op">=</span> <span class="va">nt</span>, n.iter <span class="op">=</span> <span class="va">ni</span>, n.burnin <span class="op">=</span> <span class="va">nb</span>, 
                        parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">tempemi</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
<p>Be sure to check the model for convergence and to determine whether the parameter estimates are consistent with the data generating values.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Clark Rushing.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
